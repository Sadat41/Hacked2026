import{r as a,g as xe,j as e,M as je,B as ue,A as ye,T as Z,C as Ne,P as fe,a as Te,u as ge,b as Ae}from"./index-BdVgxFF7.js";import{R as G,B as Ee,C as H,X as K,Y as U,T as V,a as J,L as X}from"./BarChart-CqIDx5y1.js";import{B as Se}from"./Brush-KfuU3UiD.js";import{L as be,a as q}from"./LineChart-D2dDLyH_.js";const M="https://api.weather.gc.ca",Q=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function k(i,o){if(o==="daily"){const p=i.slice(2,4),N=parseInt(i.slice(5,7),10)-1,l=i.slice(8,10);return`${Q[N]??i.slice(5,7)} ${l} '${p}`}const s=i.slice(2,4),x=parseInt(i.slice(5,7),10)-1;return`${Q[x]??i.slice(5,7)} '${s}`}function ve({lat:i,lng:o,zoom:s}){const x=Ae();return a.useEffect(()=>{x.flyTo([i,o],s??10,{duration:1.2})},[x,i,o,s]),null}const I=7;function De({onViewChange:i}){const o=ge({moveend:()=>i(o.getBounds(),o.getZoom()),zoomend:()=>i(o.getBounds(),o.getZoom())});return a.useEffect(()=>{i(o.getBounds(),o.getZoom())},[o,i]),null}function ke(){const[i,o]=a.useState([]),[s,x]=a.useState(null),[p,N]=a.useState(""),[l,b]=a.useState("monthly"),[f,w]=a.useState(""),[T,O]=a.useState(""),[ee,te]=a.useState([]),[se,ae]=a.useState([]),[ie,R]=a.useState(!1),[F,v]=a.useState(null),[P,ne]=a.useState(!0),[re,D]=a.useState(!1),[g,le]=a.useState(xe),[L,oe]=a.useState(null),[A,ce]=a.useState(5),B=a.useRef(void 0),j=ue[g],de=a.useCallback((t,c)=>{oe(t),ce(c)},[]);a.useEffect(()=>{async function t(){try{const S=(await(await fetch(`${M}/collections/climate-stations/items?f=json&limit=1500&ENG_PROV_NAME=ALBERTA`)).json()).features.map(d=>{const n=d.properties;return{id:n.CLIMATE_IDENTIFIER,name:n.STATION_NAME,lat:d.geometry.coordinates[1],lng:d.geometry.coordinates[0],elevation:n.ELEVATION??"",firstDate:n.FIRST_DATE?.slice(0,10)??"",lastDate:n.LAST_DATE?.slice(0,10)??"",dlyFirst:n.DLY_FIRST_DATE?.slice(0,10)??"",dlyLast:n.DLY_LAST_DATE?.slice(0,10)??"",mlyFirst:n.MLY_FIRST_DATE?.slice(0,10)??"",mlyLast:n.MLY_LAST_DATE?.slice(0,10)??"",hasDaily:!!n.DLY_FIRST_DATE,hasMonthly:!!n.MLY_FIRST_DATE}}).filter(d=>d.hasDaily||d.hasMonthly).sort((d,n)=>d.name.localeCompare(n.name));o(S)}catch{v("Failed to load station list")}finally{ne(!1)}}t()},[]);const $=a.useCallback(async(t,c,u,S)=>{B.current?.abort();const d=new AbortController;B.current=d,R(!0),v(null);try{if(c==="daily"){const n=`${M}/collections/climate-daily/items?f=json&limit=2000&CLIMATE_IDENTIFIER=${t.id}&sortby=LOCAL_DATE&datetime=${u}/${S}&properties=STATION_NAME,LOCAL_DATE,TOTAL_PRECIPITATION,TOTAL_RAIN,TOTAL_SNOW,SNOW_ON_GROUND,MEAN_TEMPERATURE`,m=await fetch(n,{signal:d.signal});if(!m.ok)throw new Error(`HTTP ${m.status}`);const y=(await m.json()).features.map(r=>({date:r.properties.LOCAL_DATE?.slice(0,10)??"",precip:r.properties.TOTAL_PRECIPITATION,rain:r.properties.TOTAL_RAIN,snow:r.properties.TOTAL_SNOW,snowDepth:r.properties.SNOW_ON_GROUND,meanTemp:r.properties.MEAN_TEMPERATURE}));y.sort((r,C)=>r.date.localeCompare(C.date)),te(y)}else{const n=`${M}/collections/climate-monthly/items?f=json&limit=2000&CLIMATE_IDENTIFIER=${t.id}&sortby=LOCAL_DATE&datetime=${u}/${S}`,m=await fetch(n,{signal:d.signal});if(!m.ok)throw new Error(`HTTP ${m.status}`);const y=(await m.json()).features.map(r=>({month:r.properties.LOCAL_DATE?.slice(0,7)??"",precip:r.properties.TOTAL_PRECIPITATION,normalPrecip:r.properties.NORMAL_PRECIPITATION,snowfall:r.properties.TOTAL_SNOWFALL,meanTemp:r.properties.MEAN_TEMPERATURE,daysWithPrecip:r.properties.DAYS_WITH_PRECIP_GE_1MM}));y.sort((r,C)=>r.month.localeCompare(C.month)),ae(y)}}catch(n){if(n.name==="AbortError")return;v(n instanceof Error?n.message:"Failed to load data")}finally{R(!1)}},[]);a.useEffect(()=>{!s||!f||!T||$(s,l,f,T)},[s,l,f,T,$]);function W(t){x(t),N(""),D(!0);const c=t.hasMonthly?"monthly":"daily";b(c),_(t)}function _(t){const c=[t.firstDate,t.dlyFirst,t.mlyFirst].filter(Boolean),u=[t.lastDate,t.dlyLast,t.mlyLast].filter(Boolean);w(c.sort()[0]||t.firstDate),O(u.sort().reverse()[0]||t.lastDate)}const E=a.useMemo(()=>{if(!p)return[];const t=p.toLowerCase();return i.filter(c=>c.name.toLowerCase().includes(t)||c.id.toLowerCase().includes(t))},[p,i]),z=a.useMemo(()=>p?E:A<I||!L?[]:i.filter(t=>L.contains([t.lat,t.lng])),[p,E,i,A,L]),h=l==="daily"?ee:se,pe=h.reduce((t,c)=>t+(c.precip??0),0),he=Math.max(...h.map(t=>t.precip??0),0),Y={background:"#1e293b",border:"1px solid #334155",borderRadius:8,color:"#e2e8f0",fontSize:12};return e.jsxs("div",{className:"precip-view",children:[e.jsxs("div",{className:"precip-sidebar",children:[e.jsxs("div",{className:"precip-sidebar-header",children:[e.jsx("h2",{children:"Precipitation Explorer"}),e.jsx("p",{className:"precip-subtitle",children:"Historical climate data · Environment Canada"})]}),e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Search Station"}),e.jsx("input",{type:"text",className:"precip-input",placeholder:"Type station name or ID...",value:p,onChange:t=>N(t.target.value)}),p&&e.jsxs("div",{className:"station-list",children:[E.slice(0,40).map(t=>e.jsxs("button",{className:`station-item ${s?.id===t.id?"active":""}`,onClick:()=>W(t),children:[e.jsxs("div",{className:"station-item-left",children:[e.jsx("span",{className:"station-name",children:t.name}),e.jsxs("span",{className:"station-dates",children:[t.firstDate.slice(0,4),"–",t.lastDate.slice(0,4)]})]}),e.jsx("span",{className:"station-meta",children:t.id})]},t.id)),E.length===0&&e.jsx("div",{className:"station-loading",children:"No stations found"})]})]}),s&&e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Selected"}),e.jsxs("div",{className:"precip-selected-station",children:[e.jsx("strong",{children:s.name}),e.jsxs("span",{children:[s.id," · ",s.elevation,"m"]}),e.jsxs("span",{children:[s.lat.toFixed(3),"N, ",Math.abs(s.lng).toFixed(3),"W"]}),e.jsxs("span",{children:["Data: ",s.firstDate," → ",s.lastDate]}),e.jsxs("div",{className:"station-badges",children:[s.hasDaily&&e.jsx("span",{className:"station-badge",children:"Daily"}),s.hasMonthly&&e.jsx("span",{className:"station-badge",children:"Monthly"})]})]}),e.jsx("button",{className:"precip-open-chart-btn",onClick:()=>D(!0),children:"View Charts"})]}),!s&&!P&&e.jsx("div",{className:"precip-section",children:e.jsx("p",{className:"precip-hint",children:A<I?e.jsxs(e.Fragment,{children:["Zoom into the map to see stations, or search above.",e.jsx("br",{}),e.jsx("strong",{children:i.length})," stations available across Alberta."]}):e.jsxs(e.Fragment,{children:["Click a station on the map or search above.",e.jsx("br",{}),e.jsx("strong",{children:z.length})," of ",i.length," stations in view."]})})}),P&&e.jsx("div",{className:"precip-section",children:e.jsx("div",{className:"precip-hint",children:"Loading stations..."})}),e.jsx("div",{className:"precip-section precip-footer-section",children:e.jsxs("p",{className:"precip-hint",style:{fontSize:11,color:"#475569"},children:["Data: ",e.jsx("a",{href:"https://api.weather.gc.ca",target:"_blank",rel:"noopener noreferrer",style:{color:"#38bdf8",textDecoration:"none"},children:"Environment Canada"})," ","·"," ",e.jsx("a",{href:"https://climate.weather.gc.ca",target:"_blank",rel:"noopener noreferrer",style:{color:"#38bdf8",textDecoration:"none"},children:"Climate Services"})]})})]}),e.jsxs("div",{className:`precip-main ${j.isDark?"theme-dark":"theme-light"}`,children:[e.jsxs(je,{center:ye,zoom:5,className:"precip-map-full",zoomControl:!0,children:[e.jsx(De,{onViewChange:de}),e.jsx(Z,{attribution:j.attr,url:j.url},g),"labelsUrl"in j&&e.jsx(Z,{url:j.labelsUrl,zIndex:650},g+"-labels"),s&&e.jsx(ve,{lat:s.lat,lng:s.lng}),z.map(t=>e.jsx(Ne,{center:[t.lat,t.lng],radius:s?.id===t.id?8:5,pathOptions:{color:s?.id===t.id?"#38bdf8":"#3b82f6",fillColor:s?.id===t.id?"#38bdf8":"#3b82f6",fillOpacity:s?.id===t.id?1:.6,weight:s?.id===t.id?2:1},eventHandlers:{click:()=>W(t)},children:e.jsx(fe,{className:"hydrogrid-popup",children:e.jsxs("div",{style:{fontFamily:"system-ui",fontSize:13},children:[e.jsx("strong",{children:t.name}),e.jsx("br",{}),t.id," · ",t.elevation,"m",e.jsx("br",{}),"Data: ",t.firstDate," → ",t.lastDate]})})},t.id))]}),e.jsx(Te,{active:g,onChange:le}),!p&&A<I&&!s&&e.jsxs("div",{className:"precip-zoom-hint",children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}),e.jsx("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),e.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),"Zoom in to see weather stations"]}),re&&s&&e.jsxs("div",{className:"chart-panel",children:[e.jsxs("div",{className:"chart-panel-header",children:[e.jsxs("div",{className:"chart-panel-title",children:[e.jsx("h3",{children:s.name}),e.jsxs("span",{className:"chart-panel-sub",children:[s.id," · ",s.elevation,"m"]})]}),e.jsxs("div",{className:"chart-panel-controls",children:[e.jsxs("div",{className:"precip-toggle-row",children:[s.hasDaily&&e.jsx("button",{className:`precip-btn ${l==="daily"?"active":""}`,onClick:()=>{b("daily"),_(s)},children:"Daily"}),s.hasMonthly&&e.jsx("button",{className:`precip-btn ${l==="monthly"?"active":""}`,onClick:()=>{b("monthly"),_(s)},children:"Monthly"})]}),e.jsxs("div",{className:"precip-date-row",children:[e.jsx("input",{type:"date",className:"precip-input sm",value:f,onChange:t=>w(t.target.value)}),e.jsx("span",{className:"precip-date-sep",children:"→"}),e.jsx("input",{type:"date",className:"precip-input sm",value:T,onChange:t=>O(t.target.value)})]}),e.jsx("button",{className:"chart-panel-close",onClick:()=>D(!1),title:"Close",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:e.jsx("path",{d:"M4 4l8 8M12 4l-8 8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]})]}),e.jsx("div",{className:"chart-panel-body",children:ie?e.jsxs("div",{className:"precip-empty-charts",children:[e.jsx("div",{className:"precip-spinner"}),e.jsx("p",{children:"Loading data..."})]}):F?e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{className:"precip-error",children:F})}):h.length===0?e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{children:"No data for this period. Try adjusting the dates."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"precip-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:h.length}),e.jsx("span",{className:"stat-label",children:"Records"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:pe.toFixed(1)}),e.jsx("span",{className:"stat-label",children:"Total (mm)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:he.toFixed(1)}),e.jsx("span",{className:"stat-label",children:"Max (mm)"})]})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Precipitation Depth (mm)"}),e.jsx(G,{width:"100%",height:220,children:e.jsxs(Ee,{data:h,children:[e.jsx(H,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(K,{dataKey:l==="daily"?"date":"month",stroke:"#64748b",tick:{fontSize:10},minTickGap:40,tickFormatter:t=>k(t,l)}),e.jsx(U,{stroke:"#64748b",tick:{fontSize:10},unit:"mm"}),e.jsx(V,{contentStyle:Y,formatter:t=>[`${t?.toFixed(1)??"N/A"} mm`]}),e.jsx(J,{dataKey:"precip",fill:"#3b82f6",name:"Precipitation",radius:[2,2,0,0]}),l==="monthly"&&e.jsx(J,{dataKey:"normalPrecip",fill:"#475569",name:"30yr Normal",radius:[2,2,0,0]}),e.jsx(X,{}),h.length>60&&e.jsx(Se,{dataKey:l==="daily"?"date":"month",height:24,stroke:"#475569",fill:"#0f172a",tickFormatter:t=>k(t,l)})]})})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Temperature (°C) & Snow"}),e.jsx(G,{width:"100%",height:180,children:e.jsxs(be,{data:h,children:[e.jsx(H,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(K,{dataKey:l==="daily"?"date":"month",stroke:"#64748b",tick:{fontSize:10},minTickGap:40,tickFormatter:t=>k(t,l)}),e.jsx(U,{stroke:"#64748b",tick:{fontSize:10}}),e.jsx(V,{contentStyle:Y}),e.jsx(q,{type:"monotone",dataKey:"meanTemp",stroke:"#f59e0b",name:"Mean Temp (°C)",dot:!1,strokeWidth:1.5}),e.jsx(q,{type:"monotone",dataKey:l==="daily"?"snowDepth":"snowfall",stroke:"#e2e8f0",name:l==="daily"?"Snow Depth (cm)":"Snowfall (cm)",dot:!1,strokeWidth:1.5}),e.jsx(X,{})]})})]})]})})]})]})]})}export{ke as default};
