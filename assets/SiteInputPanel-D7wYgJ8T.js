import{a as n,j as e,b as de,M as ue,B as pe,E as me,T as J,C as X,P as ee,c as he,u as ge,d as be}from"./index-BvPbTWQl.js";const Y="https://data.edmonton.ca/resource",_={RF1:{label:"Single Detached Residential",impervious:.45,paveFrac:.12},RSL:{label:"Residential Small Lot",impervious:.55,paveFrac:.15},RF2:{label:"Low Density Infill",impervious:.5,paveFrac:.13},RF3:{label:"Small Scale Infill",impervious:.55,paveFrac:.15},RF4:{label:"Semi-detached",impervious:.5,paveFrac:.14},RF5:{label:"Row Housing",impervious:.65,paveFrac:.2},RF6:{label:"Medium Density",impervious:.7,paveFrac:.22},RA7:{label:"Low Rise Apartment",impervious:.7,paveFrac:.2},RA8:{label:"Medium Rise Apartment",impervious:.8,paveFrac:.2},RA9:{label:"High Rise Apartment",impervious:.85,paveFrac:.18},RS:{label:"Residential Small Lot (new)",impervious:.55,paveFrac:.15},RM:{label:"Residential Mixed",impervious:.6,paveFrac:.18},RR:{label:"Rural Residential",impervious:.15,paveFrac:.05},CB1:{label:"Low Intensity Business",impervious:.85,paveFrac:.35},CB2:{label:"General Business",impervious:.9,paveFrac:.3},CB3:{label:"Commercial Mixed Business",impervious:.85,paveFrac:.3},CHY:{label:"Highway Corridor",impervious:.9,paveFrac:.4},CSC:{label:"Shopping Centre",impervious:.9,paveFrac:.45},CNC:{label:"Neighbourhood Convenience",impervious:.8,paveFrac:.3},CO:{label:"Commercial Office",impervious:.85,paveFrac:.3},MU:{label:"Mixed Use",impervious:.75,paveFrac:.22},DC1:{label:"Direct Control (provision)",impervious:.65,paveFrac:.2},DC2:{label:"Direct Control (site specific)",impervious:.65,paveFrac:.2},IB:{label:"Industrial Business",impervious:.8,paveFrac:.35},IL:{label:"Light Industrial",impervious:.75,paveFrac:.35},IM:{label:"Medium Industrial",impervious:.8,paveFrac:.4},IH:{label:"Heavy Industrial",impervious:.85,paveFrac:.45},AG:{label:"Agricultural",impervious:.05,paveFrac:.02},AGU:{label:"Agricultural Urban Reserve",impervious:.08,paveFrac:.03},US:{label:"Urban Services",impervious:.6,paveFrac:.25},A:{label:"Metropolitan Recreation",impervious:.1,paveFrac:.05},AP:{label:"Public Parks",impervious:.08,paveFrac:.03},PU:{label:"Public Utility",impervious:.5,paveFrac:.2}};function ae(i){if(!i)return null;const t=i.toUpperCase().replace(/\s+/g,"");if(_[t])return _[t];for(const r of Object.keys(_))if(t.startsWith(r))return _[r];return null}function ve(i){const t=i.trim();if(!t)return null;const r=t.match(/^(\d+)\s+(.+)/);return r?{houseNumber:r[1],street:r[2]}:null}function xe(i){const t=ve(i),r=new URLSearchParams;if(r.set("$limit","15"),t){const g=t.street.toUpperCase().replace(/'/g,"''");r.set("$where",`house_number='${t.houseNumber}' AND upper(street_name) LIKE '%${g}%' AND latitude IS NOT NULL`)}else r.set("$q",i),r.set("$where","latitude IS NOT NULL");return`${Y}/dkk9-cj3x.json?${r.toString()}`}function P(i){const t=typeof i=="number"?i:parseFloat(i);return isNaN(t)||t===0?"N/A":`${t.toLocaleString(void 0,{maximumFractionDigits:1})} m²`}function ye(){const[i,t]=n.useState("search"),[r,g]=n.useState(""),[u,f]=n.useState([]),[l,c]=n.useState(null),[S,x]=n.useState(!1),[y,j]=n.useState(!1),F=n.useRef(void 0),b=n.useRef(void 0),[d,U]=n.useState(""),[z,T]=n.useState(""),[L,O]=n.useState(""),[N,G]=n.useState(""),[A,H]=n.useState(""),[B,W]=n.useState(""),[k,K]=n.useState(!1),[C,m]=n.useState(null),[R,E]=n.useState(!1),a=n.useCallback(async o=>{const p=o.trim();if(p.length<2){f([]);return}F.current?.abort();const h=new AbortController;F.current=h,x(!0),j(!0),c(null);try{const v=await fetch(xe(p),{signal:h.signal});if(!v.ok)throw new Error(`HTTP ${v.status}`);const w=(await v.json()).map(s=>({accountNumber:s.account_number||"",address:`${s.house_number||""} ${s.street_name||""}`.trim(),lat:parseFloat(s.latitude),lng:parseFloat(s.longitude),lotSize:s.lot_size||"",totalGrossArea:s.total_gross_area||"",zoning:s.zoning||"",yearBuilt:s.year_built||"",neighbourhood:s.neighbourhood||"",garage:!!s.garage,legalDescription:s.legal_description||"",ward:s.ward||""}));f(w)}catch(v){if(v.name==="AbortError")return;f([])}finally{x(!1)}},[]),$=n.useCallback(o=>{g(o),clearTimeout(b.current),b.current=setTimeout(()=>a(o),350)},[a]),se=o=>{o.key==="Enter"&&(clearTimeout(b.current),a(r))},te=n.useCallback(async(o,p)=>{if(i==="search"){m({lat:o,lng:p}),E(!0),c(null);try{const v=new URLSearchParams({$where:`latitude > ${o-5e-4} AND latitude < ${o+5e-4} AND longitude > ${p-5e-4} AND longitude < ${p+5e-4}`,$limit:"1"}),w=await(await fetch(`${Y}/dkk9-cj3x.json?${v.toString()}`)).json();if(w[0]){const s=w[0],I={accountNumber:s.account_number||"",address:`${s.house_number||""} ${s.street_name||""}`.trim(),lat:parseFloat(s.latitude),lng:parseFloat(s.longitude),lotSize:s.lot_size||"",totalGrossArea:s.total_gross_area||"",zoning:s.zoning||"",yearBuilt:s.year_built||"",neighbourhood:s.neighbourhood||"",garage:!!s.garage,legalDescription:s.legal_description||"",ward:s.ward||""};c(I),m(null)}}catch{}finally{E(!1)}}},[i]),M=n.useMemo(()=>{if(i==="search"&&l){const o=ae(l.zoning);return{lotSize:parseFloat(l.lotSize)||0,buildingArea:parseFloat(l.totalGrossArea)||0,address:l.address,zoning:l.zoning,zoningLabel:o?.label??"Unknown",zoningImpervious:o?.impervious??.5,zoningPaveFrac:o?.paveFrac??.15,neighbourhood:l.neighbourhood,yearBuilt:l.yearBuilt,garage:l.garage,legalDescription:l.legalDescription,ward:l.ward,lat:l.lat,lng:l.lng}}if(i==="manual"){const o=parseFloat(d),p=parseFloat(z);if(o>0){const h=ae(N);return{lotSize:o,buildingArea:p>0?p:0,address:L||"Manual Entry",zoning:N,zoningLabel:h?.label??(N||"Not specified"),zoningImpervious:h?.impervious??.5,zoningPaveFrac:h?.paveFrac??.15,neighbourhood:A,yearBuilt:B,garage:k,legalDescription:"",ward:"",lat:0,lng:0}}}return null},[i,l,d,z,L,N,A,B,k]),[le,Z]=n.useState([]),[ne,q]=n.useState(!1);n.useEffect(()=>{if(!M||M.lat===0){Z([]);return}const{lat:o,lng:p}=M,h=.03;q(!0);const v=`${Y}/kiu8-nsmp.json?$where=latitude>${o-h} AND latitude<${o+h} AND longitude>${p-h} AND longitude<${p+h}&$limit=10`;fetch(v).then(D=>D.json()).then(D=>{const w=D.map(s=>{const I=parseFloat(s.latitude),oe=parseFloat(s.longitude),Q=I-o,V=oe-p,ce=Math.sqrt(Q*Q+V*V)*111;return{name:s.description||"Unknown",type:s.storm_type||"",owner:s.facility_owner||"",neighbourhood:s.neighbourhood_name||"",distKm:+ce.toFixed(2)}}).sort((s,I)=>s.distKm-I.distKm);Z(w)}).catch(()=>Z([])).finally(()=>q(!1))},[M?.lat,M?.lng]);const ie=n.useMemo(()=>l?{lat:l.lat,lng:l.lng}:C||null,[l,C]),re=n.useMemo(()=>l?[l]:u.filter(o=>!isNaN(o.lat)&&!isNaN(o.lng)),[u,l]);return{mode:i,setMode:t,query:r,handleInput:$,handleKeyDown:se,results:u,selected:l,setSelected:c,loading:S,searched:y,manualLot:d,setManualLot:U,manualBuilding:z,setManualBuilding:T,manualAddress:L,setManualAddress:O,manualZoning:N,setManualZoning:G,manualNeighbourhood:A,setManualNeighbourhood:H,manualYearBuilt:B,setManualYearBuilt:W,manualGarage:k,setManualGarage:K,clickMarker:C,setClickMarker:m,clickLoading:R,handleMapClick:te,analysisData:M,markerPos:ie,visibleMarkers:re,runSearch:a,debounceRef:b,nearbyFacilities:le,facilitiesLoading:ne}}function je({lat:i,lng:t}){const r=be(),g=n.useRef(""),u=`${i},${t}`;return u!==g.current&&(g.current=u,r.flyTo([i,t],17,{duration:1.2})),null}function Ne({onMapClick:i}){return ge({click:t=>i(t.latlng.lat,t.latlng.lng)}),null}function Se(i){const{mode:t,setMode:r,query:g,handleInput:u,handleKeyDown:f,results:l,selected:c,setSelected:S,loading:x,searched:y,manualLot:j,setManualLot:F,manualBuilding:b,setManualBuilding:d,manualAddress:U,setManualAddress:z,manualZoning:T,setManualZoning:L,manualNeighbourhood:O,setManualNeighbourhood:N,manualYearBuilt:G,setManualYearBuilt:A,manualGarage:H,setManualGarage:B,clickLoading:W,setClickMarker:k,runSearch:K,debounceRef:C,analysisData:m,nearbyFacilities:R,facilitiesLoading:E}=i;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"precip-section",children:e.jsxs("div",{className:"precip-toggle-row",children:[e.jsx("button",{className:`precip-btn ${t==="search"?"active":""}`,onClick:()=>r("search"),children:"Address Search"}),e.jsx("button",{className:`precip-btn ${t==="manual"?"active":""}`,onClick:()=>r("manual"),children:"Manual Input"})]})}),t==="search"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Edmonton Address"}),e.jsxs("div",{className:"prop-search-row",children:[e.jsx("input",{type:"text",className:"prop-input",placeholder:"e.g. 4719 111A Street",value:g,onChange:a=>u(a.target.value),onKeyDown:f}),e.jsx("button",{className:"prop-search-btn",onClick:()=>{clearTimeout(C.current),K(g)},disabled:x,children:x?e.jsx("div",{className:"prop-spinner-sm"}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})})]}),e.jsx("p",{className:"prop-hint",children:"Search an address, or click on the map to find the nearest property."})]}),y&&!c&&e.jsxs("div",{className:"precip-section",children:[e.jsxs("label",{className:"precip-label",children:["Results ",l.length>0&&e.jsx("span",{className:"prop-count",children:l.length})]}),x?e.jsxs("div",{className:"prop-loading",children:[e.jsx("div",{className:"prop-spinner"}),e.jsx("span",{children:"Searching..."})]}):l.length===0?e.jsx("p",{className:"prop-empty",children:"No properties found. Try a different address."}):e.jsx("div",{className:"prop-results",children:l.map(a=>e.jsxs("button",{className:"prop-result-card",onClick:()=>{S(a),k(null)},children:[e.jsx("div",{className:"prop-result-addr",children:a.address}),e.jsxs("div",{className:"prop-result-meta",children:[a.lotSize?P(a.lotSize):"",a.zoning?` · ${a.zoning}`:"",a.neighbourhood?` · ${a.neighbourhood}`:""]})]},a.accountNumber))})]}),c&&m&&e.jsxs("div",{className:"precip-section",children:[e.jsx("div",{className:"prop-detail-header",children:e.jsxs("button",{className:"prop-back-btn",onClick:()=>{S(null),k(null)},children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M19 12H5"}),e.jsx("path",{d:"M12 19l-7-7 7-7"})]}),"Back to results"]})}),e.jsxs("div",{className:"eng-prop-summary",children:[e.jsx("h3",{className:"eng-prop-addr",children:c.address}),e.jsxs("div",{className:"eng-prop-meta",children:[e.jsxs("span",{children:["Lot: ",P(c.lotSize)]}),e.jsxs("span",{children:["Bldg: ",P(c.totalGrossArea)]}),e.jsxs("span",{children:["Zoning: ",c.zoning||"N/A",m.zoningLabel&&m.zoningLabel!=="Unknown"?` (${m.zoningLabel})`:""]}),e.jsxs("span",{children:["Year: ",c.yearBuilt||"N/A",c.garage?" · Garage":""]}),e.jsxs("span",{children:[c.neighbourhood,c.ward?` · ${c.ward}`:""]}),c.legalDescription&&e.jsxs("span",{style:{fontSize:10,opacity:.5},children:["Legal: ",c.legalDescription]})]}),m.zoning&&e.jsxs("div",{className:"eng-prop-derived",style:{marginTop:6,fontSize:11,opacity:.7,lineHeight:1.6},children:[e.jsxs("span",{children:["Est. impervious ratio: ",e.jsxs("strong",{children:[(m.zoningImpervious*100).toFixed(0),"%"]})]}),e.jsxs("span",{children:[" · Est. pavement fraction: ",e.jsxs("strong",{children:[(m.zoningPaveFrac*100).toFixed(0),"%"]})]}),e.jsx("span",{style:{display:"block",fontSize:10,opacity:.6},children:"Estimated from zoning type — verify with site survey"})]})]}),R&&R.length>0&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("label",{className:"precip-label",style:{fontSize:11},children:"Nearby Storm Facilities (Edmonton Open Data)"}),e.jsx("div",{style:{maxHeight:100,overflowY:"auto",fontSize:10,lineHeight:1.5,opacity:.7},children:R.slice(0,5).map((a,$)=>e.jsxs("div",{style:{padding:"2px 0",borderBottom:"1px solid rgba(57,211,83,0.1)"},children:[e.jsx("strong",{children:a.name})," — ",a.type," (",a.owner,") · ",a.distKm," km"]},$))})]}),E&&e.jsx("div",{style:{fontSize:10,opacity:.5,marginTop:4},children:"Loading nearby facilities..."})]}),W&&e.jsx("div",{className:"precip-section",children:e.jsxs("div",{className:"prop-loading",children:[e.jsx("div",{className:"prop-spinner"}),e.jsx("span",{children:"Looking up property..."})]})})]}),t==="manual"&&e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Site Parameters"}),e.jsxs("div",{className:"eng-manual-form",children:[e.jsxs("div",{className:"eng-field",children:[e.jsxs("label",{className:"eng-field-label",children:["Lot Area (m²) ",e.jsx("span",{className:"eng-required",children:"*"})]}),e.jsx("input",{type:"number",className:"prop-input",placeholder:"e.g. 450",value:j,onChange:a=>F(a.target.value),min:"1"})]}),e.jsxs("div",{className:"eng-field",children:[e.jsx("label",{className:"eng-field-label",children:"Building Area (m²)"}),e.jsx("input",{type:"number",className:"prop-input",placeholder:"e.g. 180",value:b,onChange:a=>d(a.target.value),min:"0"})]}),e.jsxs("div",{className:"eng-field",children:[e.jsx("label",{className:"eng-field-label",children:"Site Name / Address"}),e.jsx("input",{type:"text",className:"prop-input",placeholder:"e.g. Proposed Lot 12",value:U,onChange:a=>z(a.target.value)})]}),e.jsxs("div",{className:"eng-field",children:[e.jsx("label",{className:"eng-field-label",children:"Zoning"}),e.jsxs("select",{className:"dc-select",style:{width:"100%"},value:T,onChange:a=>L(a.target.value),children:[e.jsx("option",{value:"",children:"— Select (optional) —"}),Object.entries(_).map(([a,$])=>e.jsxs("option",{value:a,children:[a," — ",$.label]},a))]})]}),e.jsxs("div",{className:"eng-field",children:[e.jsx("label",{className:"eng-field-label",children:"Neighbourhood"}),e.jsx("input",{type:"text",className:"prop-input",placeholder:"e.g. Bonnie Doon",value:O,onChange:a=>N(a.target.value)})]}),e.jsxs("div",{className:"eng-field",children:[e.jsx("label",{className:"eng-field-label",children:"Year Built"}),e.jsx("input",{type:"text",className:"prop-input",placeholder:"e.g. 1985",value:G,onChange:a=>A(a.target.value)})]}),e.jsxs("div",{className:"eng-field",style:{flexDirection:"row",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:H,onChange:a=>B(a.target.checked),id:"manual-garage"}),e.jsx("label",{htmlFor:"manual-garage",className:"eng-field-label",style:{margin:0},children:"Has Garage"})]})]}),!m&&e.jsx("p",{className:"prop-hint",style:{marginTop:10},children:"Enter at least a lot area to run the analysis."})]})]})}function Fe(i){const{handleMapClick:t,markerPos:r,visibleMarkers:g,selected:u,setSelected:f,setClickMarker:l,clickMarker:c,clickLoading:S,mode:x,compact:y}=i,[j,F]=n.useState(de),b=pe[j];return e.jsxs("div",{className:`site-map-panel ${y?"site-map-compact":""}`,style:y?{position:"relative"}:void 0,children:[e.jsxs(ue,{center:me,zoom:11,className:y?"site-map-compact-container":"precip-map-full",zoomControl:!0,children:[e.jsx(Ne,{onMapClick:t}),e.jsx(J,{attribution:b.attr,url:b.url},j),"labelsUrl"in b&&e.jsx(J,{url:b.labelsUrl,zIndex:650},j+"-labels"),r&&e.jsx(je,{lat:r.lat,lng:r.lng}),x==="search"&&g.map(d=>e.jsx(X,{center:[d.lat,d.lng],radius:u?.accountNumber===d.accountNumber?10:6,pathOptions:{color:u?.accountNumber===d.accountNumber?"#22d3ee":"#38bdf8",fillColor:u?.accountNumber===d.accountNumber?"#22d3ee":"#38bdf8",fillOpacity:u?.accountNumber===d.accountNumber?.9:.5,weight:u?.accountNumber===d.accountNumber?3:1.5},eventHandlers:{click:()=>{f(d),l(null)}},children:e.jsx(ee,{className:"hydrogrid-popup",maxWidth:360,children:e.jsxs("div",{style:{fontFamily:"system-ui",fontSize:13,maxWidth:320},children:[e.jsx("div",{style:{fontWeight:700,fontSize:14,marginBottom:6,borderBottom:"2px solid #22d3ee",paddingBottom:4},children:d.address}),e.jsx("table",{style:{borderCollapse:"collapse"},children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:600,padding:"2px 8px 2px 0",opacity:.65},children:"Lot Area"}),e.jsx("td",{style:{fontWeight:700},children:P(d.lotSize)})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:600,padding:"2px 8px 2px 0",opacity:.65},children:"Building"}),e.jsx("td",{children:P(d.totalGrossArea)})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{fontWeight:600,padding:"2px 8px 2px 0",opacity:.65},children:"Zoning"}),e.jsx("td",{children:d.zoning||"N/A"})]})]})})]})})},d.accountNumber)),c&&!u&&e.jsx(X,{center:[c.lat,c.lng],radius:8,pathOptions:{color:"#f59e0b",fillColor:"#f59e0b",fillOpacity:.7,weight:2},children:e.jsx(ee,{className:"hydrogrid-popup",children:e.jsx("div",{style:{fontFamily:"system-ui",fontSize:12},children:S?"Searching nearby properties...":"No property found at this location"})})})]}),e.jsx(he,{active:j,onChange:F})]})}export{Se as S,Fe as a,ye as u};
