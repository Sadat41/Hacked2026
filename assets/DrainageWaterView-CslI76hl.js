import{a,b as Q,j as e,M as X,B as ee,E as te,Z as se,T as G,c as ne,f as U,L as R}from"./index-mf4xxJ1P.js";const q="https://data.edmonton.ca/resource/bh8y-pn5j.json",J="https://data.edmonton.ca/resource/6waz-yxqq.json",B=5e4,_={STORM:{color:"#38bdf8",dash:[],weight:2,label:"Storm",style:"Solid"},SANITARY:{color:"#a855f7",dash:[8,4],weight:2,label:"Sanitary",style:"Dashed"},COMBINED:{color:"#f97316",dash:[2,4],weight:2,label:"Combined",style:"Dotted"},"FND DRAIN":{color:"#22d3ee",dash:[],weight:1.2,label:"Fnd Drain",style:"Thin solid"},WATER:{color:"#3b82f6",dash:[],weight:2,label:"Water",style:"Solid"}},W={"110-119":"#e11d48","100-109":"#dc2626","90-99":"#ef4444","80-89":"#7c3aed","70-79":"#c026d3","60-69":"#2563eb","50-59":"#3b82f6","40-49":"#0ea5e9","30-39":"#06b6d4","20-29":"#0891b2","10-19":"#0d9488","0-9":"#10b981",Unknown:"#6b7280"},Y=["110-119","100-109","90-99","80-89","70-79","60-69","50-59","40-49","30-39","20-29","10-19","0-9","Unknown"],K=new Date().getFullYear();function P(o){if(!o||o<=0)return"Unknown";const r=K-o;if(r<0)return"Unknown";if(r>=120)return"110-119";const t=Math.floor(r/10)*10;return`${t}-${t+9}`}function V(o,r){const t=r?.properties?.type,i=r?.properties?.year_const,c=i?parseInt(i,10):null;if(o==="type"){const d=_[t];return{color:d?.color??"#888",weight:d?.weight??2,opacity:.85,dashArray:d?.dash?.length?d.dash.join(" "):void 0}}return{color:W[P(c)]??"#888",weight:2,opacity:.85}}function ae(){const o=U();return a.useEffect(()=>{setTimeout(()=>o.invalidateSize(),100)},[o]),null}function oe({pipes:o,viewMode:r,visibleTypes:t}){const i=U(),c=a.useRef(null),d=a.useRef(null),p=a.useRef(null),m=a.useRef(r);m.current=r;const f=a.useMemo(()=>{const u=[];for(const l of o)t[l.type]&&u.push({type:"Feature",geometry:l.geometry,properties:{type:l.type,year_const:l.year_const}});return{type:"FeatureCollection",features:u}},[o,t]);return a.useEffect(()=>{if(c.current&&(i.removeLayer(c.current),c.current=null),f.features.length===0)return;d.current||(d.current=R.canvas({padding:.5})),p.current||(p.current=R.popup({className:"hydrogrid-popup",maxWidth:280}));const u=p.current,l={style:y=>V(m.current,y),renderer:d.current,onEachFeature:(y,E)=>{E.on("click",N=>{const w=y.properties??{},j=w.year_const||"Unknown",v=w.year_const?K-parseInt(w.year_const,10):"?";u.setLatLng(N.latlng).setContent(`<div style="font-family:monospace;font-size:12px;max-width:240px">
                <div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:3px">${w.type??"Pipe"}</div>
                <table style="border-collapse:collapse">
                  <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Year</td><td>${j}</td></tr>
                  <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Age</td><td>${v} yrs</td></tr>
                </table>
              </div>`).openOn(i)})}},g=R.geoJSON(f,l);return g.addTo(i),c.current=g,()=>{c.current&&(i.removeLayer(c.current),c.current=null)}},[f,i]),a.useEffect(()=>{c.current?.setStyle(u=>V(r,u))},[r]),null}const O=15;function re({viewMode:o,visible:r}){const t=U(),i=a.useRef(null),c=a.useRef(null),d=a.useRef(null),p=a.useRef(null),m=a.useRef(o);m.current=o;const f=a.useCallback(()=>{i.current&&(t.removeLayer(i.current),i.current=null)},[t]),u=a.useCallback(()=>{f(),p.current?.abort();const l=t.getZoom();if(l<O||!r)return;const g=new AbortController;p.current=g;const y=t.getBounds(),E=y.getSouthWest(),N=y.getNorthEast(),w=`latitude > ${E.lat} AND latitude < ${N.lat} AND longitude > ${E.lng} AND longitude < ${N.lng}`,j=l>=17?8e3:l>=16?5e3:3e3;fetch(`${J}?$where=${encodeURIComponent(w)}&$select=type,year_const,latitude,longitude,road_name&$limit=${j}`,{signal:g.signal}).then(v=>v.json()).then(v=>{if(g.signal.aborted||t.getZoom()<O)return;c.current||(c.current=R.canvas({padding:.5})),d.current||(d.current=R.popup({className:"hydrogrid-popup",maxWidth:240}));const M=d.current,A=m.current,L=R.layerGroup();for(const b of v){const x=parseFloat(b.latitude),T=parseFloat(b.longitude);if(isNaN(x)||isNaN(T))continue;const C=b.year_const?parseInt(b.year_const,10):null,I=P(C),Z=A==="type"?"#94a3b8":W[I]??"#94a3b8",D=R.circleMarker([x,T],{radius:3,color:"#e2e8f0",weight:.5,fillColor:Z,fillOpacity:.8,renderer:c.current});D.on("click",z=>{M.setLatLng(z.latlng).setContent(`<div style="font-family:monospace;font-size:12px;max-width:200px">
                  <div style="font-weight:700;margin-bottom:4px">Manhole — ${b.type}</div>
                  <div>Year: ${b.year_const||"Unknown"}</div>
                  ${b.road_name?`<div>Road: ${b.road_name}</div>`:""}
                </div>`).openOn(t)}),L.addLayer(D)}L.addTo(t),i.current=L}).catch(()=>{})},[t,r,f]);return a.useEffect(()=>{let l;const g=()=>{t.getZoom()<O?(f(),p.current?.abort()):(clearTimeout(l),l=setTimeout(u,300))},y=()=>{t.getZoom()>=O&&(clearTimeout(l),l=setTimeout(u,300))};return t.on("zoomend",g),t.on("moveend",y),t.getZoom()>=O&&r&&(l=setTimeout(u,300)),()=>{clearTimeout(l),t.off("zoomend",g),t.off("moveend",y),p.current?.abort(),f()}},[t,r,f,u]),null}async function ce(o,r){const t=[];let i=0;for(;;){if(r.aborted)return t;const c=`${q}?$select=type,year_const,geometry_line&$limit=${B}&$offset=${i}&$order=:id`,p=await(await fetch(c,{signal:r})).json();for(const m of p)m.geometry_line?.coordinates?.[0]?.[0]&&t.push({type:m.type,year_const:m.year_const,geometry:m.geometry_line});if(o(t.length),p.length<B)break;i+=B}return t}function ie(){const[o,r]=a.useState("age"),[t,i]=a.useState(Q),[c,d]=a.useState([]),[p,m]=a.useState([]),[f,u]=a.useState(!0),[l,g]=a.useState([]),[y,E]=a.useState(0),[N,w]=a.useState(!1),[j,v]=a.useState(()=>{const s={};for(const n of Object.keys(_))s[n]=!0;return s.MANHOLE=!0,s});a.useEffect(()=>{let s=!1;return(async()=>{u(!0);try{const[n,S]=await Promise.all([fetch(`${q}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`),fetch(`${J}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`)]);if(s)return;d(await n.json()),m(await S.json())}catch{}s||u(!1)})(),()=>{s=!0}},[]),a.useEffect(()=>{const s=new AbortController;return ce(n=>E(n),s.signal).then(n=>{s.signal.aborted||(g(n),w(!0))}).catch(()=>{}),()=>s.abort()},[]);const{ageData:M,typeData:A,totalPipes:L,totalManholes:b}=a.useMemo(()=>{const s={};for(const h of Y)s[h]={pipes:0,manholes:0};const n={};for(const h of Object.keys(_))n[h]={pipes:0,manholes:0};let S=0,H=0;for(const h of c){const $=parseInt(h.cnt,10)||0,k=P(parseInt(h.year_const,10)||0);s[k]&&(s[k].pipes+=$),n[h.type]&&(n[h.type].pipes+=$),S+=$}for(const h of p){const $=parseInt(h.cnt,10)||0,k=P(parseInt(h.year_const,10)||0);s[k]&&(s[k].manholes+=$),n[h.type]&&(n[h.type].manholes+=$),H+=$}return{ageData:s,typeData:n,totalPipes:S,totalManholes:H}},[c,p]),x=ee[t],T=a.useMemo(()=>Math.max(1,...Object.values(o==="age"?M:A).map(n=>n.pipes)),[o,M,A]),C=s=>v(n=>({...n,[s]:!n[s]})),I=o==="age"?Y:Object.keys(_),Z=o==="age"?M:A,D=o==="age"?W:Object.fromEntries(Object.entries(_).map(([s,n])=>[s,n.color])),z=j.MANHOLE,F=N?null:`Loading pipes... ${y.toLocaleString()}`;return e.jsxs("div",{className:"dw-view",children:[e.jsxs("aside",{className:"dw-sidebar",children:[e.jsxs("div",{className:"dw-sidebar-header",children:[e.jsx("h2",{children:"Edmonton Drainage & Regional Water"}),f?e.jsx("p",{className:"dw-subtitle",children:"Loading statistics..."}):e.jsxs("p",{className:"dw-subtitle",children:["Total: ",e.jsx("strong",{children:L.toLocaleString()})," pipe segments •"," ",e.jsx("strong",{children:b.toLocaleString()})," manholes"]})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"View By"}),e.jsxs("div",{className:"dw-toggle-row",children:[e.jsx("button",{className:`dw-toggle-btn ${o==="age"?"active":""}`,onClick:()=>r("age"),children:"Age"}),e.jsx("button",{className:`dw-toggle-btn ${o==="type"?"active":""}`,onClick:()=>r("type"),children:"Type"})]})]}),e.jsxs("div",{className:"dw-section dw-chart-section",children:[e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:o==="age"?"Age (years)":"Type"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),e.jsx("div",{className:"dw-bar-list",children:I.map(s=>{const n=Z[s]??{pipes:0,manholes:0},S=n.pipes/T*100;return e.jsxs("div",{className:"dw-bar-row",children:[e.jsx("span",{className:"dw-bar-label",children:s}),e.jsx("div",{className:"dw-bar-track",children:e.jsx("div",{className:"dw-bar-fill",style:{width:`${Math.max(S,.5)}%`,backgroundColor:D[s]??"#888"}})}),e.jsx("span",{className:"dw-bar-value",children:n.pipes.toLocaleString()}),e.jsx("span",{className:"dw-bar-value",children:n.manholes.toLocaleString()})]},s)})})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"Legend & Visibility"}),e.jsxs("div",{className:"dw-legend",children:[Object.entries(_).map(([s,n])=>e.jsxs("button",{className:`dw-legend-item ${j[s]?"active":""}`,onClick:()=>C(s),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("line",{x1:"0",y1:"5",x2:"32",y2:"5",stroke:n.color,strokeWidth:n.weight,strokeDasharray:n.dash.length?n.dash.join(" "):void 0})}),e.jsxs("span",{className:"dw-legend-label",children:[n.label," — ",n.style]})]},s)),e.jsxs("button",{className:`dw-legend-item ${j.MANHOLE?"active":""}`,onClick:()=>C("MANHOLE"),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("circle",{cx:"16",cy:"5",r:"4",fill:"#94a3b8",stroke:"#e2e8f0",strokeWidth:"1"})}),e.jsx("span",{className:"dw-legend-label",children:"Manhole"})]})]}),e.jsx("p",{className:"dw-note",children:"Manholes appear at zoom 15+ (close-up). Click legend to toggle layers."})]}),e.jsx("div",{className:"dw-section dw-footer",children:e.jsxs("p",{children:["Data:"," ",e.jsx("a",{href:"https://data.edmonton.ca",target:"_blank",rel:"noopener noreferrer",children:"Edmonton Open Data"})," / ",e.jsx("a",{href:"https://www.epcor.com",target:"_blank",rel:"noopener noreferrer",children:"EPCOR"})]})})]}),e.jsxs("div",{className:`dw-map-outer ${x.isDark?"theme-dark":"theme-light"}`,children:[F&&e.jsx("div",{className:"dw-map-loading",children:F}),e.jsxs(X,{center:te,zoom:12,className:"map-container",zoomControl:!1,preferCanvas:!0,children:[e.jsx(se,{position:"bottomright"}),e.jsx(ae,{}),e.jsx(G,{attribution:x.attr,url:x.url,..."maxZoom"in x?{maxZoom:x.maxZoom}:{}},t),"labelsUrl"in x&&e.jsx(G,{url:x.labelsUrl,zIndex:650},t+"-labels"),N&&e.jsx(oe,{pipes:l,viewMode:o,visibleTypes:j}),e.jsx(re,{viewMode:o,visible:z})]}),e.jsx(ne,{active:t,onChange:i})]})]})}export{ie as default};
