import{a as r,b as le,j as e,M as ce,B as oe,A as de,T as V,C as he,P as me,c as pe,u as xe,d as je}from"./index-7yA-TPag.js";import{R as D,B as R,C,X as M,Y as L,T as w,a as $,L as _}from"./BarChart-CMOolatC.js";import{B as J}from"./Brush-BjZlh8CM.js";import{L as ue,a as fe}from"./LineChart-y8JEFw6C.js";import"./with-selector-CnRev4OS.js";const I="https://api.weather.gc.ca",ge=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function z(i){const c=i.slice(2,4),a=parseInt(i.slice(5,7),10)-1;return`${ge[a]??i.slice(5,7)} '${c}`}function Ne({lat:i,lng:c,zoom:a}){const k=je();return r.useEffect(()=>{k.flyTo([i,c],a??10,{duration:1.2})},[k,i,c,a]),null}const H=7;function ye({onViewChange:i}){const c=xe({moveend:()=>i(c.getBounds(),c.getZoom()),zoomend:()=>i(c.getBounds(),c.getZoom())});return r.useEffect(()=>{i(c.getBounds(),c.getZoom())},[c,i]),null}function Te(){const[i,c]=r.useState([]),[a,k]=r.useState(null),[h,K]=r.useState(""),[x,O]=r.useState("monthly"),[j,X]=r.useState([]),[f,q]=r.useState([]),[Q,v]=r.useState(!1),[Y,g]=r.useState(null),[G,ee]=r.useState(!0),[se,B]=r.useState(!1),[b,ae]=r.useState(le),[F,te]=r.useState(null),[A,re]=r.useState(5),S=r.useRef(void 0),N=oe[b],ne=r.useCallback((s,t)=>{te(s),re(t)},[]);r.useEffect(()=>{async function s(){try{const d=(await(await fetch(`${I}/collections/hydrometric-stations/items?f=json&limit=1500&PROV_TERR_STATE_LOC=AB`)).json()).features.map(m=>{const n=m.properties;return{id:n.STATION_NUMBER,name:n.STATION_NAME,lat:m.geometry.coordinates[1],lng:m.geometry.coordinates[0],drainageArea:n.DRAINAGE_AREA_GROSS??null,status:n.STATION_STATUS??"",schedule:n.STATION_OPERATION_SCHEDULE??"",dataType:n.DATA_TYPE??"",contributor:n.STATION_CONTRIBUTOR??""}}).sort((m,n)=>m.name.localeCompare(n.name));c(d)}catch{g("Failed to load hydrometric stations")}finally{ee(!1)}}s()},[]);const P=r.useCallback(async s=>{S.current?.abort();const t=new AbortController;S.current=t,v(!0),g(null);try{const l=`${I}/collections/hydrometric-monthly-mean/items?f=json&limit=2000&STATION_NUMBER=${s.id}&sortby=DATE`,d=await fetch(l,{signal:t.signal});if(!d.ok)throw new Error(`HTTP ${d.status}`);const n=(await d.json()).features.map(u=>({month:u.properties.DATE?.slice(0,7)??"",level:u.properties.MONTHLY_MEAN_LEVEL,discharge:u.properties.MONTHLY_MEAN_DISCHARGE}));n.sort((u,y)=>u.month.localeCompare(y.month)),X(n)}catch(l){if(l.name==="AbortError")return;g(l instanceof Error?l.message:"Failed to load data")}finally{v(!1)}},[]),U=r.useCallback(async s=>{S.current?.abort();const t=new AbortController;S.current=t,v(!0),g(null);try{const l=`${I}/collections/hydrometric-annual-peaks/items?f=json&limit=2000&STATION_NUMBER=${s.id}&sortby=DATE`,d=await fetch(l,{signal:t.signal});if(!d.ok)throw new Error(`HTTP ${d.status}`);const m=await d.json(),n={};for(const y of m.features){const o=y.properties,p=o.DATE?.slice(0,4)??"";p&&(n[p]||(n[p]={year:p,peakDischarge:null,peakLevel:null,dischDate:"",levelDate:""}),o.DATA_TYPE==="Q"||o.DATA_TYPE_EN==="Flow"?(n[p].peakDischarge=o.PEAK,n[p].dischDate=o.DATE?.slice(0,10)??""):(o.DATA_TYPE==="H"||o.DATA_TYPE_EN==="Level")&&(n[p].peakLevel=o.PEAK,n[p].levelDate=o.DATE?.slice(0,10)??""))}const u=Object.values(n).sort((y,o)=>y.year.localeCompare(o.year));q(u)}catch(l){if(l.name==="AbortError")return;g(l instanceof Error?l.message:"Failed to load data")}finally{v(!1)}},[]);function W(s){k(s),K(""),B(!0),O("monthly"),P(s)}r.useEffect(()=>{a&&(x==="monthly"?P(a):x==="peaks"&&U(a))},[x,a,P,U]);const T=r.useMemo(()=>{if(!h)return[];const s=h.toLowerCase();return i.filter(t=>t.name.toLowerCase().includes(s)||t.id.toLowerCase().includes(s))},[h,i]),Z=r.useMemo(()=>h?T:A<H||!F?[]:i.filter(s=>F.contains([s.lat,s.lng])),[h,T,i,A,F]),E={background:"#1e293b",border:"1px solid #334155",borderRadius:8,color:"#e2e8f0",fontSize:12};function ie(){if(Q)return e.jsxs("div",{className:"precip-empty-charts",children:[e.jsx("div",{className:"precip-spinner"}),e.jsx("p",{children:"Loading data..."})]});if(Y)return e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{className:"precip-error",children:Y})});if(x==="monthly"){if(j.length===0)return e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{children:"No monthly data available for this station."})});const s=j.reduce((t,l)=>t+(l.discharge??0),0)/(j.filter(t=>t.discharge!=null).length||1);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"precip-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:j.length}),e.jsx("span",{className:"stat-label",children:"Months"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:s.toFixed(1)}),e.jsx("span",{className:"stat-label",children:"Avg (m³/s)"})]})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Monthly Mean Discharge (m³/s)"}),e.jsx(D,{width:"100%",height:220,children:e.jsxs(R,{data:j,children:[e.jsx(C,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(M,{dataKey:"month",stroke:"#64748b",tick:{fontSize:10},minTickGap:40,tickFormatter:z}),e.jsx(L,{stroke:"#64748b",tick:{fontSize:10},unit:" m³/s"}),e.jsx(w,{contentStyle:E,formatter:t=>[`${t?.toFixed(2)??"N/A"} m³/s`]}),e.jsx($,{dataKey:"discharge",fill:"#2dd4bf",name:"Mean Discharge",radius:[2,2,0,0]}),e.jsx(_,{}),j.length>60&&e.jsx(J,{dataKey:"month",height:24,stroke:"#475569",fill:"#0f172a",tickFormatter:z})]})})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Monthly Mean Water Level (m)"}),e.jsx(D,{width:"100%",height:180,children:e.jsxs(ue,{data:j,children:[e.jsx(C,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(M,{dataKey:"month",stroke:"#64748b",tick:{fontSize:10},minTickGap:40,tickFormatter:z}),e.jsx(L,{stroke:"#64748b",tick:{fontSize:10},unit:" m"}),e.jsx(w,{contentStyle:E,formatter:t=>[`${t?.toFixed(3)??"N/A"} m`]}),e.jsx(fe,{type:"monotone",dataKey:"level",stroke:"#38bdf8",name:"Mean Level",dot:!1,strokeWidth:1.5}),e.jsx(_,{})]})})]})]})}if(x==="peaks"){if(f.length===0)return e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{children:"No annual peak data available."})});const s=Math.max(...f.map(t=>t.peakDischarge??0),0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"precip-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:f.length}),e.jsx("span",{className:"stat-label",children:"Years"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:s.toFixed(0)}),e.jsx("span",{className:"stat-label",children:"Record Peak (m³/s)"})]})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Annual Peak Discharge (m³/s)"}),e.jsx(D,{width:"100%",height:220,children:e.jsxs(R,{data:f,children:[e.jsx(C,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(M,{dataKey:"year",stroke:"#64748b",tick:{fontSize:10},minTickGap:30}),e.jsx(L,{stroke:"#64748b",tick:{fontSize:10},unit:" m³/s"}),e.jsx(w,{contentStyle:E,formatter:(t,l)=>[`${t?.toFixed(1)??"N/A"} ${l?.includes("Level")?"m":"m³/s"}`]}),e.jsx($,{dataKey:"peakDischarge",fill:"#f59e0b",name:"Peak Discharge",radius:[2,2,0,0]}),e.jsx(_,{}),f.length>40&&e.jsx(J,{dataKey:"year",height:24,stroke:"#475569",fill:"#0f172a"})]})})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Annual Peak Water Level (m)"}),e.jsx(D,{width:"100%",height:180,children:e.jsxs(R,{data:f,children:[e.jsx(C,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(M,{dataKey:"year",stroke:"#64748b",tick:{fontSize:10},minTickGap:30}),e.jsx(L,{stroke:"#64748b",tick:{fontSize:10},unit:" m"}),e.jsx(w,{contentStyle:E,formatter:t=>[`${t?.toFixed(3)??"N/A"} m`]}),e.jsx($,{dataKey:"peakLevel",fill:"#38bdf8",name:"Peak Level",radius:[2,2,0,0]}),e.jsx(_,{})]})})]})]})}return null}return e.jsxs("div",{className:"precip-view",children:[e.jsxs("div",{className:"precip-sidebar",children:[e.jsxs("div",{className:"precip-sidebar-header",children:[e.jsx("h2",{children:"River Flow"}),e.jsx("p",{className:"precip-subtitle",children:"Hydrometric data · Environment Canada"})]}),e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Search Station"}),e.jsx("input",{type:"text",className:"precip-input",placeholder:"Type station name or ID...",value:h,onChange:s=>K(s.target.value)}),h&&e.jsxs("div",{className:"station-list",children:[T.slice(0,40).map(s=>e.jsxs("button",{className:`station-item ${a?.id===s.id?"active":""}`,onClick:()=>W(s),children:[e.jsxs("div",{className:"station-item-left",children:[e.jsx("span",{className:"station-name",children:s.name}),e.jsxs("span",{className:"station-dates",children:[s.status," · ",s.schedule]})]}),e.jsx("span",{className:"station-meta",children:s.id})]},s.id)),T.length===0&&e.jsx("div",{className:"station-loading",children:"No stations found"})]})]}),a&&e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Selected"}),e.jsxs("div",{className:"precip-selected-station",children:[e.jsx("strong",{children:a.name}),e.jsx("span",{children:a.id}),e.jsxs("span",{children:[a.lat.toFixed(3),"N, ",Math.abs(a.lng).toFixed(3),"W"]}),a.drainageArea&&e.jsxs("span",{children:["Drainage: ",a.drainageArea.toLocaleString()," km²"]}),e.jsxs("span",{children:["Status: ",a.status]}),e.jsxs("div",{className:"station-badges",children:[e.jsx("span",{className:"station-badge",children:"Flow"}),e.jsx("span",{className:"station-badge",children:"Level"})]})]}),e.jsx("button",{className:"precip-open-chart-btn",onClick:()=>B(!0),children:"View Charts"})]}),!a&&!G&&e.jsx("div",{className:"precip-section",children:e.jsx("p",{className:"precip-hint",children:A<H?e.jsxs(e.Fragment,{children:["Zoom into the map to see stations, or search above.",e.jsx("br",{}),e.jsx("strong",{children:i.length})," hydrometric stations across Alberta."]}):e.jsxs(e.Fragment,{children:["Click a station on the map or search above.",e.jsx("br",{}),e.jsx("strong",{children:Z.length})," of ",i.length," stations in view."]})})}),G&&e.jsx("div",{className:"precip-section",children:e.jsx("div",{className:"precip-hint",children:"Loading stations..."})}),e.jsx("div",{className:"precip-section precip-footer-section",children:e.jsxs("p",{className:"precip-hint",style:{fontSize:11,color:"#475569"},children:["Data: ",e.jsx("a",{href:"https://api.weather.gc.ca",target:"_blank",rel:"noopener noreferrer",style:{color:"#2dd4bf",textDecoration:"none"},children:"Environment Canada"})," ","·"," ",e.jsx("a",{href:"https://wateroffice.ec.gc.ca",target:"_blank",rel:"noopener noreferrer",style:{color:"#2dd4bf",textDecoration:"none"},children:"Water Office"})]})})]}),e.jsxs("div",{className:`precip-main ${N.isDark?"theme-dark":"theme-light"}`,children:[e.jsxs(ce,{center:de,zoom:5,className:"precip-map-full",zoomControl:!0,children:[e.jsx(ye,{onViewChange:ne}),e.jsx(V,{attribution:N.attr,url:N.url},b),"labelsUrl"in N&&e.jsx(V,{url:N.labelsUrl,zIndex:650},b+"-labels"),a&&e.jsx(Ne,{lat:a.lat,lng:a.lng}),Z.map(s=>e.jsx(he,{center:[s.lat,s.lng],radius:a?.id===s.id?8:5,pathOptions:{color:a?.id===s.id?"#2dd4bf":"#14b8a6",fillColor:a?.id===s.id?"#2dd4bf":"#14b8a6",fillOpacity:a?.id===s.id?1:.6,weight:a?.id===s.id?2:1},eventHandlers:{click:()=>W(s)},children:e.jsx(me,{className:"hydrogrid-popup",children:e.jsxs("div",{style:{fontFamily:"system-ui",fontSize:13},children:[e.jsx("strong",{children:s.name}),e.jsx("br",{}),s.id," · ",s.status,s.drainageArea&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"Drainage: ",s.drainageArea.toLocaleString()," km²"]})]})})},s.id))]}),e.jsx(pe,{active:b,onChange:ae}),!h&&A<H&&!a&&e.jsxs("div",{className:"precip-zoom-hint",children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}),e.jsx("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),e.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),"Zoom in to see hydrometric stations"]}),se&&a&&e.jsxs("div",{className:"chart-panel",children:[e.jsxs("div",{className:"chart-panel-header",children:[e.jsxs("div",{className:"chart-panel-title",children:[e.jsx("h3",{children:a.name}),e.jsxs("span",{className:"chart-panel-sub",children:[a.id,a.drainageArea?` · ${a.drainageArea.toLocaleString()} km²`:""]})]}),e.jsxs("div",{className:"chart-panel-controls",children:[e.jsxs("div",{className:"precip-toggle-row",children:[e.jsx("button",{className:`precip-btn ${x==="monthly"?"active":""}`,onClick:()=>O("monthly"),children:"Monthly"}),e.jsx("button",{className:`precip-btn ${x==="peaks"?"active":""}`,onClick:()=>O("peaks"),children:"Peaks"})]}),e.jsx("button",{className:"chart-panel-close",onClick:()=>B(!1),title:"Close",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:e.jsx("path",{d:"M4 4l8 8M12 4l-8 8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]})]}),e.jsx("div",{className:"chart-panel-body",children:ie()})]})]})]})}export{Te as default};
