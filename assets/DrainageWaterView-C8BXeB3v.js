import{a as l,b as ae,j as e,M as ne,B as oe,E as le,Z as re,T as P,G as ie,C as ce,P as de,c as pe,f as he,u as ge}from"./index-BsFql9q5.js";const T="https://data.edmonton.ca/resource/bh8y-pn5j.json",D="https://data.edmonton.ca/resource/6waz-yxqq.json",S=5e4,u={STORM:{color:"#38bdf8",dash:[],weight:2,label:"Storm",style:"Solid"},SANITARY:{color:"#a855f7",dash:[8,4],weight:2,label:"Sanitary",style:"Dashed"},COMBINED:{color:"#f97316",dash:[2,4],weight:2,label:"Combined",style:"Dotted"},"FND DRAIN":{color:"#22d3ee",dash:[],weight:1.2,label:"Fnd Drain",style:"Thin solid"},WATER:{color:"#3b82f6",dash:[],weight:2,label:"Water",style:"Solid"}},$={"110-119":"#e11d48","100-109":"#dc2626","90-99":"#ef4444","80-89":"#7c3aed","70-79":"#c026d3","60-69":"#2563eb","50-59":"#3b82f6","40-49":"#0ea5e9","30-39":"#06b6d4","20-29":"#0891b2","10-19":"#0d9488","0-9":"#10b981",Unknown:"#6b7280"},R=["110-119","100-109","90-99","80-89","70-79","60-69","50-59","40-49","30-39","20-29","10-19","0-9","Unknown"],I=new Date().getFullYear();function b(a){if(!a||a<=0)return"Unknown";const i=I-a;if(i<0)return"Unknown";if(i>=120)return"110-119";const d=Math.floor(i/10)*10;return`${d}-${d+9}`}function me(){const a=he();return l.useEffect(()=>{setTimeout(()=>a.invalidateSize(),100)},[a]),null}function ue({onMove:a}){const i=ge({moveend:()=>a(i.getBounds(),i.getZoom()),zoomend:()=>a(i.getBounds(),i.getZoom())});return l.useEffect(()=>{a(i.getBounds(),i.getZoom())},[i,a]),null}async function ye(a,i){const d=[];let f=0;for(;;){if(i.aborted)return d;const x=`${T}?$select=type,year_const,geometry_line&$limit=${S}&$offset=${f}&$order=:id`,y=await(await fetch(x,{signal:i})).json();if(d.push(...y),a(d.length),y.length<S)break;f+=S}return d}function xe(){const[a,i]=l.useState("age"),[d,f]=l.useState(ae),[x,M]=l.useState([]),[y,B]=l.useState([]),[U,E]=l.useState(!0),[_,W]=l.useState([]),[z,F]=l.useState(0),[Z,w]=l.useState(!0),[G,A]=l.useState([]),[H,k]=l.useState(!1),[g,Y]=l.useState(()=>{const t={};for(const s of Object.keys(u))t[s]=!0;return t.MANHOLE=!0,t}),C=l.useRef(null);l.useEffect(()=>{let t=!1;async function s(){E(!0);try{const[o,c]=await Promise.all([fetch(`${T}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`),fetch(`${D}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`)]);if(t)return;const n=await o.json(),r=await c.json();t||(M(n),B(r))}catch{}t||E(!1)}return s(),()=>{t=!0}},[]),l.useEffect(()=>{const t=new AbortController;return w(!0),ye(s=>F(s),t.signal).then(s=>{t.signal.aborted||(W(s),w(!1))}).catch(()=>{t.signal.aborted||w(!1)}),()=>t.abort()},[]);const V=l.useCallback(async(t,s)=>{if(s<13){A([]);return}C.current?.abort();const o=new AbortController;C.current=o;const c=t.getSouthWest(),n=t.getNorthEast(),r=`latitude > ${c.lat} AND latitude < ${n.lat} AND longitude > ${c.lng} AND longitude < ${n.lng}`,h=s>=15?1e4:4e3;k(!0);try{const se=await(await fetch(`${D}?$where=${encodeURIComponent(r)}&$select=type,year_const,latitude,longitude,road_name&$limit=${h}`,{signal:o.signal})).json();o.signal.aborted||A(se)}catch{}o.signal.aborted||k(!1)},[]),{ageData:j,typeData:N,totalPipes:J,totalManholes:q}=l.useMemo(()=>{const t={};for(const n of R)t[n]={pipes:0,manholes:0};const s={};for(const n of Object.keys(u))s[n]={pipes:0,manholes:0};let o=0,c=0;for(const n of x){const r=parseInt(n.cnt,10)||0,h=parseInt(n.year_const,10)||0,m=b(h);t[m]&&(t[m].pipes+=r),s[n.type]&&(s[n.type].pipes+=r),o+=r}for(const n of y){const r=parseInt(n.cnt,10)||0,h=parseInt(n.year_const,10)||0,m=b(h);t[m]&&(t[m].manholes+=r),s[n.type]&&(s[n.type].manholes+=r),c+=r}return{ageData:t,typeData:s,totalPipes:o,totalManholes:c}},[x,y]),v=l.useMemo(()=>{const t=[];for(const s of _)s.geometry_line&&g[s.type]&&t.push({type:"Feature",geometry:s.geometry_line,properties:{type:s.type,year_const:s.year_const}});return{type:"FeatureCollection",features:t}},[_,g]),K=l.useCallback(t=>{const s=t?.properties?.type,o=t?.properties?.year_const,c=o?parseInt(o,10):null;if(a==="type"){const r=u[s];return{color:r?.color??"#888",weight:r?.weight??2,opacity:.85,dashArray:r?.dash?.length?r.dash.join(" "):void 0}}const n=b(c);return{color:$[n]??"#888",weight:2,opacity:.85}},[a]),p=oe[d],Q=l.useMemo(()=>Math.max(1,...Object.values(a==="age"?j:N).map(s=>s.pipes)),[a,j,N]),L=t=>Y(s=>({...s,[t]:!s[t]})),X=a==="age"?R:Object.keys(u),ee=a==="age"?j:N,te=a==="age"?$:Object.fromEntries(Object.entries(u).map(([t,s])=>[t,s.color])),O=Z?`Loading pipes... ${z.toLocaleString()} segments`:H?"Loading manholes...":null;return e.jsxs("div",{className:"dw-view",children:[e.jsxs("aside",{className:"dw-sidebar",children:[e.jsxs("div",{className:"dw-sidebar-header",children:[e.jsx("h2",{children:"Edmonton Drainage & Regional Water"}),U?e.jsx("p",{className:"dw-subtitle",children:"Loading statistics..."}):e.jsxs("p",{className:"dw-subtitle",children:["Total: ",e.jsx("strong",{children:J.toLocaleString()})," pipe segments •"," ",e.jsx("strong",{children:q.toLocaleString()})," manholes"]})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"View By"}),e.jsxs("div",{className:"dw-toggle-row",children:[e.jsx("button",{className:`dw-toggle-btn ${a==="age"?"active":""}`,onClick:()=>i("age"),children:"Age"}),e.jsx("button",{className:`dw-toggle-btn ${a==="type"?"active":""}`,onClick:()=>i("type"),children:"Type"})]})]}),e.jsxs("div",{className:"dw-section dw-chart-section",children:[e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:a==="age"?"Age (years)":"Type"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),e.jsx("div",{className:"dw-bar-list",children:X.map(t=>{const s=ee[t]??{pipes:0,manholes:0},o=s.pipes/Q*100;return e.jsxs("div",{className:"dw-bar-row",children:[e.jsx("span",{className:"dw-bar-label",children:t}),e.jsx("div",{className:"dw-bar-track",children:e.jsx("div",{className:"dw-bar-fill",style:{width:`${Math.max(o,.5)}%`,backgroundColor:te[t]??"#888"}})}),e.jsx("span",{className:"dw-bar-value",children:s.pipes.toLocaleString()}),e.jsx("span",{className:"dw-bar-value",children:s.manholes.toLocaleString()})]},t)})})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"Legend & Visibility"}),e.jsxs("div",{className:"dw-legend",children:[Object.entries(u).map(([t,s])=>e.jsxs("button",{className:`dw-legend-item ${g[t]?"active":""}`,onClick:()=>L(t),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("line",{x1:"0",y1:"5",x2:"32",y2:"5",stroke:s.color,strokeWidth:s.weight,strokeDasharray:s.dash.length?s.dash.join(" "):void 0})}),e.jsxs("span",{className:"dw-legend-label",children:[s.label," — ",s.style]})]},t)),e.jsxs("button",{className:`dw-legend-item ${g.MANHOLE?"active":""}`,onClick:()=>L("MANHOLE"),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("circle",{cx:"16",cy:"5",r:"4",fill:"#94a3b8",stroke:"#e2e8f0",strokeWidth:"1"})}),e.jsx("span",{className:"dw-legend-label",children:"Manhole"})]})]}),e.jsx("p",{className:"dw-note",children:"Manholes appear at zoom 13+. Click items to toggle."})]}),e.jsx("div",{className:"dw-section dw-footer",children:e.jsxs("p",{children:["Data:"," ",e.jsx("a",{href:"https://data.edmonton.ca",target:"_blank",rel:"noopener noreferrer",children:"Edmonton Open Data"})," / ",e.jsx("a",{href:"https://www.epcor.com",target:"_blank",rel:"noopener noreferrer",children:"EPCOR"})]})})]}),e.jsxs("div",{className:`dw-map-outer ${p.isDark?"theme-dark":"theme-light"}`,children:[O&&e.jsx("div",{className:"dw-map-loading",children:O}),e.jsxs(ne,{center:le,zoom:12,className:"map-container",zoomControl:!1,preferCanvas:!0,children:[e.jsx(re,{position:"bottomright"}),e.jsx(me,{}),e.jsx(ue,{onMove:V}),e.jsx(P,{attribution:p.attr,url:p.url,..."maxZoom"in p?{maxZoom:p.maxZoom}:{}},d),"labelsUrl"in p&&e.jsx(P,{url:p.labelsUrl,zIndex:650},d+"-labels"),v.features.length>0&&e.jsx(ie,{data:v,style:K,onEachFeature:(t,s)=>{const o=t.properties??{},c=o.year_const||"Unknown",n=o.year_const?I-parseInt(o.year_const,10):"?";s.bindPopup(`<div style="font-family:monospace;font-size:12px;max-width:240px">
                    <div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:3px">${o.type??"Pipe"}</div>
                    <table style="border-collapse:collapse">
                      <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Year</td><td>${c}</td></tr>
                      <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Age</td><td>${n} yrs</td></tr>
                    </table>
                  </div>`,{className:"hydrogrid-popup",maxWidth:280})}},`pipes-${v.features.length}-${a}-${JSON.stringify(g)}`),g.MANHOLE&&G.map((t,s)=>{const o=parseFloat(t.latitude),c=parseFloat(t.longitude);if(isNaN(o)||isNaN(c))return null;const n=t.year_const?parseInt(t.year_const,10):null,r=b(n),h=a==="type"?"#94a3b8":$[r]??"#94a3b8";return e.jsx(ce,{center:[o,c],radius:3,pathOptions:{color:"#e2e8f0",weight:.5,fillColor:h,fillOpacity:.8},children:e.jsx(de,{className:"hydrogrid-popup",maxWidth:240,children:e.jsxs("div",{style:{fontFamily:"monospace",fontSize:12,maxWidth:200},children:[e.jsxs("div",{style:{fontWeight:700,marginBottom:4},children:["Manhole — ",t.type]}),e.jsxs("div",{children:["Year: ",t.year_const||"Unknown"]}),t.road_name&&e.jsxs("div",{children:["Road: ",t.road_name]})]})})},`mh-${s}`)})]}),e.jsx(pe,{active:d,onChange:f})]})]})}export{xe as default};
