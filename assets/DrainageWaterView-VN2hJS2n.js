import{a as l,b as ce,j as e,M as de,B as pe,E as he,Z as ge,T as W,G as ue,C as me,P as ye,c as fe,f as xe,u as we}from"./index-DxMJu8fA.js";const H="https://data.edmonton.ca/resource/bh8y-pn5j.json",G="https://data.edmonton.ca/resource/6waz-yxqq.json",E=5e4,f={STORM:{color:"#38bdf8",dash:[],weight:2,label:"Storm",style:"Solid"},SANITARY:{color:"#a855f7",dash:[8,4],weight:2,label:"Sanitary",style:"Dashed"},COMBINED:{color:"#f97316",dash:[2,4],weight:2,label:"Combined",style:"Dotted"},"FND DRAIN":{color:"#22d3ee",dash:[],weight:1.2,label:"Fnd Drain",style:"Thin solid"},WATER:{color:"#3b82f6",dash:[],weight:2,label:"Water",style:"Solid"}},L={"110-119":"#e11d48","100-109":"#dc2626","90-99":"#ef4444","80-89":"#7c3aed","70-79":"#c026d3","60-69":"#2563eb","50-59":"#3b82f6","40-49":"#0ea5e9","30-39":"#06b6d4","20-29":"#0891b2","10-19":"#0d9488","0-9":"#10b981",Unknown:"#6b7280"},Z=["110-119","100-109","90-99","80-89","70-79","60-69","50-59","40-49","30-39","20-29","10-19","0-9","Unknown"],V=new Date().getFullYear();function S(n){if(!n||n<=0)return"Unknown";const i=V-n;if(i<0)return"Unknown";if(i>=120)return"110-119";const p=Math.floor(i/10)*10;return`${p}-${p+9}`}const be={type:"FeatureCollection",features:[]};function je(){const n=xe();return l.useEffect(()=>{setTimeout(()=>n.invalidateSize(),100)},[n]),null}function Ne({onViewport:n}){const i=we({moveend:()=>n(i.getBounds(),i.getZoom()),zoomend:()=>n(i.getBounds(),i.getZoom())});return l.useEffect(()=>{n(i.getBounds(),i.getZoom())},[i,n]),null}async function ve(n,i){const p=[];let w=0;for(;;){if(i.aborted)return p;const b=`${H}?$select=type,year_const,geometry_line&$limit=${E}&$offset=${w}&$order=:id`,x=await(await fetch(b,{signal:i})).json();for(const u of x){if(!u.geometry_line?.coordinates?.[0]?.[0])continue;const j=u.geometry_line.coordinates[0][0];p.push({type:u.type,year_const:u.year_const,geometry:u.geometry_line,lng:j[0],lat:j[1]})}if(n(p.length),x.length<E)break;w+=E}return p}function $e(){const[n,i]=l.useState("age"),[p,w]=l.useState(ce),[b,A]=l.useState([]),[x,u]=l.useState([]),[j,C]=l.useState(!0),[k,Y]=l.useState([]),[J,q]=l.useState(0),[N,K]=l.useState(!1),[d,Q]=l.useState(null),[P,O]=l.useState([]),[X,R]=l.useState(!1),[m,ee]=l.useState(()=>{const t={};for(const s of Object.keys(f))t[s]=!0;return t.MANHOLE=!0,t}),T=l.useRef(null),D=l.useRef(void 0);l.useEffect(()=>{let t=!1;return(async()=>{C(!0);try{const[s,o]=await Promise.all([fetch(`${H}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`),fetch(`${G}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`)]);if(t)return;A(await s.json()),u(await o.json())}catch{}t||C(!1)})(),()=>{t=!0}},[]),l.useEffect(()=>{const t=new AbortController;return ve(s=>q(s),t.signal).then(s=>{t.signal.aborted||(Y(s),K(!0))}).catch(()=>{}),()=>t.abort()},[]);const te=l.useCallback((t,s)=>{clearTimeout(D.current),D.current=setTimeout(()=>{const o=t.getSouthWest(),r=t.getNorthEast(),a=3;Q({swLat:parseFloat(o.lat.toFixed(a)),swLng:parseFloat(o.lng.toFixed(a)),neLat:parseFloat(r.lat.toFixed(a)),neLng:parseFloat(r.lng.toFixed(a)),zoom:Math.round(s)})},300)},[]);l.useEffect(()=>{if(!d)return;if(d.zoom<13||!m.MANHOLE){O([]);return}T.current?.abort();const t=new AbortController;T.current=t;const s=`latitude > ${d.swLat} AND latitude < ${d.neLat} AND longitude > ${d.swLng} AND longitude < ${d.neLng}`,o=d.zoom>=15?1e4:4e3;return R(!0),fetch(`${G}?$where=${encodeURIComponent(s)}&$select=type,year_const,latitude,longitude,road_name&$limit=${o}`,{signal:t.signal}).then(r=>r.json()).then(r=>{t.signal.aborted||O(r)}).catch(()=>{}).finally(()=>{t.signal.aborted||R(!1)}),()=>t.abort()},[d,m]);const{ageData:M,typeData:$,totalPipes:se,totalManholes:ae}=l.useMemo(()=>{const t={};for(const a of Z)t[a]={pipes:0,manholes:0};const s={};for(const a of Object.keys(f))s[a]={pipes:0,manholes:0};let o=0,r=0;for(const a of b){const c=parseInt(a.cnt,10)||0,g=S(parseInt(a.year_const,10)||0);t[g]&&(t[g].pipes+=c),s[a.type]&&(s[a.type].pipes+=c),o+=c}for(const a of x){const c=parseInt(a.cnt,10)||0,g=S(parseInt(a.year_const,10)||0);t[g]&&(t[g].manholes+=c),s[a.type]&&(s[a.type].manholes+=c),r+=c}return{ageData:t,typeData:s,totalPipes:o,totalManholes:r}},[b,x]),{pipeGeoJson:F,pipeCount:I}=l.useMemo(()=>{if(!d||!N)return{pipeGeoJson:be,pipeCount:0};const{swLat:t,swLng:s,neLat:o,neLng:r,zoom:a}=d,c=[];for(const h of k)m[h.type]&&h.lat>=t&&h.lat<=o&&h.lng>=s&&h.lng<=r&&c.push(h);const g=a>=15?6e4:a>=13?4e4:a>=11?2e4:8e3;let v=c;if(c.length>g){const h=Math.ceil(c.length/g);v=[];for(let _=0;_<c.length;_+=h)v.push(c[_])}return{pipeGeoJson:{type:"FeatureCollection",features:v.map(h=>({type:"Feature",geometry:h.geometry,properties:{type:h.type,year_const:h.year_const}}))},pipeCount:v.length}},[k,N,d,m]),ne=l.useCallback(t=>{const s=t?.properties?.type,o=t?.properties?.year_const,r=o?parseInt(o,10):null;if(n==="type"){const a=f[s];return{color:a?.color??"#888",weight:a?.weight??2,opacity:.85,dashArray:a?.dash?.length?a.dash.join(" "):void 0}}return{color:L[S(r)]??"#888",weight:2,opacity:.85}},[n]),y=pe[p],oe=l.useMemo(()=>Math.max(1,...Object.values(n==="age"?M:$).map(s=>s.pipes)),[n,M,$]),z=t=>ee(s=>({...s,[t]:!s[t]})),le=n==="age"?Z:Object.keys(f),re=n==="age"?M:$,ie=n==="age"?L:Object.fromEntries(Object.entries(f).map(([t,s])=>[t,s.color])),B=m.MANHOLE&&(d?.zoom??0)>=13,U=N?X?"Loading manholes...":null:`Loading pipes... ${J.toLocaleString()}`;return e.jsxs("div",{className:"dw-view",children:[e.jsxs("aside",{className:"dw-sidebar",children:[e.jsxs("div",{className:"dw-sidebar-header",children:[e.jsx("h2",{children:"Edmonton Drainage & Regional Water"}),j?e.jsx("p",{className:"dw-subtitle",children:"Loading statistics..."}):e.jsxs("p",{className:"dw-subtitle",children:["Total: ",e.jsx("strong",{children:se.toLocaleString()})," pipe segments •"," ",e.jsx("strong",{children:ae.toLocaleString()})," manholes"]})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"View By"}),e.jsxs("div",{className:"dw-toggle-row",children:[e.jsx("button",{className:`dw-toggle-btn ${n==="age"?"active":""}`,onClick:()=>i("age"),children:"Age"}),e.jsx("button",{className:`dw-toggle-btn ${n==="type"?"active":""}`,onClick:()=>i("type"),children:"Type"})]})]}),e.jsxs("div",{className:"dw-section dw-chart-section",children:[e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:n==="age"?"Age (years)":"Type"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),e.jsx("div",{className:"dw-bar-list",children:le.map(t=>{const s=re[t]??{pipes:0,manholes:0},o=s.pipes/oe*100;return e.jsxs("div",{className:"dw-bar-row",children:[e.jsx("span",{className:"dw-bar-label",children:t}),e.jsx("div",{className:"dw-bar-track",children:e.jsx("div",{className:"dw-bar-fill",style:{width:`${Math.max(o,.5)}%`,backgroundColor:ie[t]??"#888"}})}),e.jsx("span",{className:"dw-bar-value",children:s.pipes.toLocaleString()}),e.jsx("span",{className:"dw-bar-value",children:s.manholes.toLocaleString()})]},t)})})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"Legend & Visibility"}),e.jsxs("div",{className:"dw-legend",children:[Object.entries(f).map(([t,s])=>e.jsxs("button",{className:`dw-legend-item ${m[t]?"active":""}`,onClick:()=>z(t),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("line",{x1:"0",y1:"5",x2:"32",y2:"5",stroke:s.color,strokeWidth:s.weight,strokeDasharray:s.dash.length?s.dash.join(" "):void 0})}),e.jsxs("span",{className:"dw-legend-label",children:[s.label," — ",s.style]})]},t)),e.jsxs("button",{className:`dw-legend-item ${m.MANHOLE?"active":""}`,onClick:()=>z("MANHOLE"),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("circle",{cx:"16",cy:"5",r:"4",fill:"#94a3b8",stroke:"#e2e8f0",strokeWidth:"1"})}),e.jsx("span",{className:"dw-legend-label",children:"Manhole"})]})]}),e.jsx("p",{className:"dw-note",children:"Manholes visible at zoom 13+. Pipes thin out when zoomed far out. Click legend to toggle."})]}),N&&d&&e.jsx("div",{className:"dw-section",children:e.jsxs("p",{className:"dw-note",style:{fontStyle:"normal"},children:["Showing ",e.jsx("strong",{children:I.toLocaleString()})," pipes in view",B&&e.jsxs(e.Fragment,{children:[" • ",e.jsx("strong",{children:P.length.toLocaleString()})," manholes"]})]})}),e.jsx("div",{className:"dw-section dw-footer",children:e.jsxs("p",{children:["Data:"," ",e.jsx("a",{href:"https://data.edmonton.ca",target:"_blank",rel:"noopener noreferrer",children:"Edmonton Open Data"})," / ",e.jsx("a",{href:"https://www.epcor.com",target:"_blank",rel:"noopener noreferrer",children:"EPCOR"})]})})]}),e.jsxs("div",{className:`dw-map-outer ${y.isDark?"theme-dark":"theme-light"}`,children:[U&&e.jsx("div",{className:"dw-map-loading",children:U}),e.jsxs(de,{center:he,zoom:12,className:"map-container",zoomControl:!1,preferCanvas:!0,children:[e.jsx(ge,{position:"bottomright"}),e.jsx(je,{}),e.jsx(Ne,{onViewport:te}),e.jsx(W,{attribution:y.attr,url:y.url,..."maxZoom"in y?{maxZoom:y.maxZoom}:{}},p),"labelsUrl"in y&&e.jsx(W,{url:y.labelsUrl,zIndex:650},p+"-labels"),F.features.length>0&&e.jsx(ue,{data:F,style:ne,onEachFeature:(t,s)=>{const o=t.properties??{},r=o.year_const||"Unknown",a=o.year_const?V-parseInt(o.year_const,10):"?";s.bindPopup(`<div style="font-family:monospace;font-size:12px;max-width:240px">
                    <div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:3px">${o.type??"Pipe"}</div>
                    <table style="border-collapse:collapse">
                      <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Year</td><td>${r}</td></tr>
                      <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Age</td><td>${a} yrs</td></tr>
                    </table>
                  </div>`,{className:"hydrogrid-popup",maxWidth:280})}},`p-${I}-${n}`),B&&P.map((t,s)=>{const o=parseFloat(t.latitude),r=parseFloat(t.longitude);if(isNaN(o)||isNaN(r))return null;const a=t.year_const?parseInt(t.year_const,10):null,c=S(a),g=n==="type"?"#94a3b8":L[c]??"#94a3b8";return e.jsx(me,{center:[o,r],radius:3,pathOptions:{color:"#e2e8f0",weight:.5,fillColor:g,fillOpacity:.8},children:e.jsx(ye,{className:"hydrogrid-popup",maxWidth:240,children:e.jsxs("div",{style:{fontFamily:"monospace",fontSize:12,maxWidth:200},children:[e.jsxs("div",{style:{fontWeight:700,marginBottom:4},children:["Manhole — ",t.type]}),e.jsxs("div",{children:["Year: ",t.year_const||"Unknown"]}),t.road_name&&e.jsxs("div",{children:["Road: ",t.road_name]})]})})},`mh-${s}`)})]}),e.jsx(fe,{active:p,onChange:w})]})]})}export{$e as default};
