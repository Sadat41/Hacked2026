import{a as r,b as le,j as e,M as oe,B as ce,A as de,T as Z,C as he,P as me,c as pe,d as xe,e as je,u as ue,f as fe}from"./index-nFvCTMw8.js";import{R as C,B as R,C as M,X as D,Y as w,T as L,a as $,L as _}from"./BarChart-Q2Jf12Y3.js";import{B as J}from"./Brush-D_iQdu64.js";import{L as ge,a as Ne}from"./LineChart-lPM24wlR.js";import"./with-selector-D49ObT-M.js";const I="https://api.weather.gc.ca",ke=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function z(i){const o=i.slice(2,4),a=parseInt(i.slice(5,7),10)-1;return`${ke[a]??i.slice(5,7)} '${o}`}function ve({lat:i,lng:o,zoom:a}){const v=fe();return r.useEffect(()=>{v.flyTo([i,o],a??10,{duration:1.2})},[v,i,o,a]),null}const H=7;function ye({onViewChange:i}){const o=ue({moveend:()=>i(o.getBounds(),o.getZoom()),zoomend:()=>i(o.getBounds(),o.getZoom())});return r.useEffect(()=>{i(o.getBounds(),o.getZoom())},[o,i]),null}function Ce(){const[i,o]=r.useState([]),[a,v]=r.useState(null),[m,K]=r.useState(""),[j,B]=r.useState("monthly"),[d,q]=r.useState([]),[f,X]=r.useState([]),[Q,y]=r.useState(!1),[Y,g]=r.useState(null),[G,ee]=r.useState(!0),[se,O]=r.useState(!1),[b,ae]=r.useState(le),[P,te]=r.useState(null),[S,re]=r.useState(5),A=r.useRef(void 0),N=ce[b],ne=r.useCallback((s,t)=>{te(s),re(t)},[]);r.useEffect(()=>{async function s(){try{const h=(await(await fetch(`${I}/collections/hydrometric-stations/items?f=json&limit=1500&PROV_TERR_STATE_LOC=AB`)).json()).features.map(p=>{const n=p.properties;return{id:n.STATION_NUMBER,name:n.STATION_NAME,lat:p.geometry.coordinates[1],lng:p.geometry.coordinates[0],drainageArea:n.DRAINAGE_AREA_GROSS??null,status:n.STATION_STATUS??"",schedule:n.STATION_OPERATION_SCHEDULE??"",dataType:n.DATA_TYPE??"",contributor:n.STATION_CONTRIBUTOR??""}}).sort((p,n)=>p.name.localeCompare(n.name));o(h)}catch{g("Failed to load hydrometric stations")}finally{ee(!1)}}s()},[]);const F=r.useCallback(async s=>{A.current?.abort();const t=new AbortController;A.current=t,y(!0),g(null);try{const l=`${I}/collections/hydrometric-monthly-mean/items?f=json&limit=2000&STATION_NUMBER=${s.id}&sortby=DATE`,h=await fetch(l,{signal:t.signal});if(!h.ok)throw new Error(`HTTP ${h.status}`);const n=(await h.json()).features.map(u=>({month:u.properties.DATE?.slice(0,7)??"",level:u.properties.MONTHLY_MEAN_LEVEL,discharge:u.properties.MONTHLY_MEAN_DISCHARGE}));n.sort((u,k)=>u.month.localeCompare(k.month)),q(n)}catch(l){if(l.name==="AbortError")return;g(l instanceof Error?l.message:"Failed to load data")}finally{y(!1)}},[]),W=r.useCallback(async s=>{A.current?.abort();const t=new AbortController;A.current=t,y(!0),g(null);try{const l=`${I}/collections/hydrometric-annual-peaks/items?f=json&limit=2000&STATION_NUMBER=${s.id}&sortby=DATE`,h=await fetch(l,{signal:t.signal});if(!h.ok)throw new Error(`HTTP ${h.status}`);const p=await h.json(),n={};for(const k of p.features){const c=k.properties,x=c.DATE?.slice(0,4)??"";x&&(n[x]||(n[x]={year:x,peakDischarge:null,peakLevel:null,dischDate:"",levelDate:""}),c.DATA_TYPE==="Q"||c.DATA_TYPE_EN==="Flow"?(n[x].peakDischarge=c.PEAK,n[x].dischDate=c.DATE?.slice(0,10)??""):(c.DATA_TYPE==="H"||c.DATA_TYPE_EN==="Level")&&(n[x].peakLevel=c.PEAK,n[x].levelDate=c.DATE?.slice(0,10)??""))}const u=Object.values(n).sort((k,c)=>k.year.localeCompare(c.year));X(u)}catch(l){if(l.name==="AbortError")return;g(l instanceof Error?l.message:"Failed to load data")}finally{y(!1)}},[]);function U(s){v(s),K(""),O(!0),B("monthly"),F(s)}r.useEffect(()=>{a&&(j==="monthly"?F(a):j==="peaks"&&W(a))},[j,a,F,W]);const T=r.useMemo(()=>{if(!m)return[];const s=m.toLowerCase();return i.filter(t=>t.name.toLowerCase().includes(s)||t.id.toLowerCase().includes(s))},[m,i]),V=r.useMemo(()=>m?T:S<H||!P?[]:i.filter(s=>P.contains([s.lat,s.lng])),[m,T,i,S,P]),E={background:"#1e293b",border:"1px solid #334155",borderRadius:8,color:"#e2e8f0",fontSize:12};function ie(){if(Q)return e.jsxs("div",{className:"precip-empty-charts",children:[e.jsx("div",{className:"precip-spinner"}),e.jsx("p",{children:"Loading data..."})]});if(Y)return e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{className:"precip-error",children:Y})});if(j==="monthly"){if(d.length===0)return e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{children:"No monthly data available for this station."})});const s=d.reduce((t,l)=>t+(l.discharge??0),0)/(d.filter(t=>t.discharge!=null).length||1);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"precip-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:d.length}),e.jsx("span",{className:"stat-label",children:"Months"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:s.toFixed(1)}),e.jsx("span",{className:"stat-label",children:"Avg (m³/s)"})]})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Monthly Mean Discharge (m³/s)"}),e.jsx(C,{width:"100%",height:220,children:e.jsxs(R,{data:d,children:[e.jsx(M,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(D,{dataKey:"month",stroke:"#64748b",tick:{fontSize:10},minTickGap:40,tickFormatter:z}),e.jsx(w,{stroke:"#64748b",tick:{fontSize:10},unit:" m³/s"}),e.jsx(L,{contentStyle:E,formatter:t=>[`${t?.toFixed(2)??"N/A"} m³/s`]}),e.jsx($,{dataKey:"discharge",fill:"#2dd4bf",name:"Mean Discharge",radius:[2,2,0,0]}),e.jsx(_,{}),d.length>60&&e.jsx(J,{dataKey:"month",height:24,stroke:"#475569",fill:"#0f172a",tickFormatter:z})]})})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Monthly Mean Water Level (m)"}),e.jsx(C,{width:"100%",height:180,children:e.jsxs(ge,{data:d,children:[e.jsx(M,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(D,{dataKey:"month",stroke:"#64748b",tick:{fontSize:10},minTickGap:40,tickFormatter:z}),e.jsx(w,{stroke:"#64748b",tick:{fontSize:10},unit:" m"}),e.jsx(L,{contentStyle:E,formatter:t=>[`${t?.toFixed(3)??"N/A"} m`]}),e.jsx(Ne,{type:"monotone",dataKey:"level",stroke:"#38bdf8",name:"Mean Level",dot:!1,strokeWidth:1.5}),e.jsx(_,{})]})})]})]})}if(j==="peaks"){if(f.length===0)return e.jsx("div",{className:"precip-empty-charts",children:e.jsx("p",{children:"No annual peak data available."})});const s=Math.max(...f.map(t=>t.peakDischarge??0),0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"precip-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:f.length}),e.jsx("span",{className:"stat-label",children:"Years"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:s.toFixed(0)}),e.jsx("span",{className:"stat-label",children:"Record Peak (m³/s)"})]})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Annual Peak Discharge (m³/s)"}),e.jsx(C,{width:"100%",height:220,children:e.jsxs(R,{data:f,children:[e.jsx(M,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(D,{dataKey:"year",stroke:"#64748b",tick:{fontSize:10},minTickGap:30}),e.jsx(w,{stroke:"#64748b",tick:{fontSize:10},unit:" m³/s"}),e.jsx(L,{contentStyle:E,formatter:(t,l)=>[`${t?.toFixed(1)??"N/A"} ${l?.includes("Level")?"m":"m³/s"}`]}),e.jsx($,{dataKey:"peakDischarge",fill:"#f59e0b",name:"Peak Discharge",radius:[2,2,0,0]}),e.jsx(_,{}),f.length>40&&e.jsx(J,{dataKey:"year",height:24,stroke:"#475569",fill:"#0f172a"})]})})]}),e.jsxs("div",{className:"precip-chart-section",children:[e.jsx("h4",{children:"Annual Peak Water Level (m)"}),e.jsx(C,{width:"100%",height:180,children:e.jsxs(R,{data:f,children:[e.jsx(M,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(D,{dataKey:"year",stroke:"#64748b",tick:{fontSize:10},minTickGap:30}),e.jsx(w,{stroke:"#64748b",tick:{fontSize:10},unit:" m"}),e.jsx(L,{contentStyle:E,formatter:t=>[`${t?.toFixed(3)??"N/A"} m`]}),e.jsx($,{dataKey:"peakLevel",fill:"#38bdf8",name:"Peak Level",radius:[2,2,0,0]}),e.jsx(_,{})]})})]})]})}return null}return e.jsxs("div",{className:"precip-view",children:[e.jsxs("div",{className:"precip-sidebar",children:[e.jsxs("div",{className:"precip-sidebar-header",children:[e.jsx("h2",{children:"River Flow"}),e.jsx("p",{className:"precip-subtitle",children:"Hydrometric data · Environment Canada"})]}),e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Search Station"}),e.jsx("input",{type:"text",className:"precip-input",placeholder:"Type station name or ID...",value:m,onChange:s=>K(s.target.value)}),m&&e.jsxs("div",{className:"station-list",children:[T.slice(0,40).map(s=>e.jsxs("button",{className:`station-item ${a?.id===s.id?"active":""}`,onClick:()=>U(s),children:[e.jsxs("div",{className:"station-item-left",children:[e.jsx("span",{className:"station-name",children:s.name}),e.jsxs("span",{className:"station-dates",children:[s.status," · ",s.schedule]})]}),e.jsx("span",{className:"station-meta",children:s.id})]},s.id)),T.length===0&&e.jsx("div",{className:"station-loading",children:"No stations found"})]})]}),a&&e.jsxs("div",{className:"precip-section",children:[e.jsx("label",{className:"precip-label",children:"Selected"}),e.jsxs("div",{className:"precip-selected-station",children:[e.jsx("strong",{children:a.name}),e.jsx("span",{children:a.id}),e.jsxs("span",{children:[a.lat.toFixed(3),"N, ",Math.abs(a.lng).toFixed(3),"W"]}),a.drainageArea&&e.jsxs("span",{children:["Drainage: ",a.drainageArea.toLocaleString()," km²"]}),e.jsxs("span",{children:["Status: ",a.status]}),e.jsxs("div",{className:"station-badges",children:[e.jsx("span",{className:"station-badge",children:"Flow"}),e.jsx("span",{className:"station-badge",children:"Level"})]})]}),e.jsx("button",{className:"precip-open-chart-btn",onClick:()=>O(!0),children:"View Charts"})]}),!a&&!G&&e.jsx("div",{className:"precip-section",children:e.jsx("p",{className:"precip-hint",children:S<H?e.jsxs(e.Fragment,{children:["Zoom into the map to see stations, or search above.",e.jsx("br",{}),e.jsx("strong",{children:i.length})," hydrometric stations across Alberta."]}):e.jsxs(e.Fragment,{children:["Click a station on the map or search above.",e.jsx("br",{}),e.jsx("strong",{children:V.length})," of ",i.length," stations in view."]})})}),G&&e.jsx("div",{className:"precip-section",children:e.jsx("div",{className:"precip-hint",children:"Loading stations..."})}),e.jsx("div",{className:"precip-section precip-footer-section",children:e.jsxs("p",{className:"precip-hint",style:{fontSize:11,color:"#475569"},children:["Data: ",e.jsx("a",{href:"https://api.weather.gc.ca",target:"_blank",rel:"noopener noreferrer",style:{color:"#2dd4bf",textDecoration:"none"},children:"Environment Canada"})," ","·"," ",e.jsx("a",{href:"https://wateroffice.ec.gc.ca",target:"_blank",rel:"noopener noreferrer",style:{color:"#2dd4bf",textDecoration:"none"},children:"Water Office"})]})})]}),e.jsxs("div",{className:`precip-main ${N.isDark?"theme-dark":"theme-light"}`,children:[e.jsxs(oe,{center:de,zoom:11,className:"precip-map-full",zoomControl:!0,children:[e.jsx(ye,{onViewChange:ne}),e.jsx(Z,{attribution:N.attr,url:N.url},b),"labelsUrl"in N&&e.jsx(Z,{url:N.labelsUrl,zIndex:650},b+"-labels"),a&&e.jsx(ve,{lat:a.lat,lng:a.lng}),V.map(s=>e.jsx(he,{center:[s.lat,s.lng],radius:a?.id===s.id?8:5,pathOptions:{color:a?.id===s.id?"#2dd4bf":"#14b8a6",fillColor:a?.id===s.id?"#2dd4bf":"#14b8a6",fillOpacity:a?.id===s.id?1:.6,weight:a?.id===s.id?2:1},eventHandlers:{click:()=>U(s)},children:e.jsx(me,{className:"hydrogrid-popup",children:e.jsxs("div",{style:{fontFamily:"system-ui",fontSize:13},children:[e.jsx("strong",{children:s.name}),e.jsx("br",{}),s.id," · ",s.status,s.drainageArea&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),"Drainage: ",s.drainageArea.toLocaleString()," km²"]})]})})},s.id))]}),e.jsx(pe,{active:b,onChange:ae}),!m&&S<H&&!a&&e.jsxs("div",{className:"precip-zoom-hint",children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}),e.jsx("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),e.jsx("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),"Zoom in to see hydrometric stations"]}),se&&a&&e.jsxs("div",{className:"chart-panel",children:[e.jsxs("div",{className:"chart-panel-header",children:[e.jsxs("div",{className:"chart-panel-title",children:[e.jsx("h3",{children:a.name}),e.jsxs("span",{className:"chart-panel-sub",children:[a.id,a.drainageArea?` · ${a.drainageArea.toLocaleString()} km²`:""]})]}),e.jsxs("div",{className:"chart-panel-controls",children:[e.jsxs("div",{className:"precip-toggle-row",children:[e.jsx("button",{className:`precip-btn ${j==="monthly"?"active":""}`,onClick:()=>B("monthly"),children:"Monthly"}),e.jsx("button",{className:`precip-btn ${j==="peaks"?"active":""}`,onClick:()=>B("peaks"),children:"Peaks"})]}),e.jsx("button",{className:"chart-panel-close",onClick:()=>O(!1),title:"Close",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:e.jsx("path",{d:"M4 4l8 8M12 4l-8 8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})]}),d.length>0&&e.jsxs("div",{className:"export-bar",children:[e.jsxs("button",{className:"export-btn",onClick:()=>xe(d,`hydrometric_${a?.name||"data"}.csv`),children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"})}),"CSV"]}),e.jsxs("button",{className:"export-btn",onClick:()=>{const s=document.querySelector(".chart-panel-body");s&&je(s,`hydrometric_${a?.name||"chart"}.png`)},children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"})}),"PNG"]})]})]}),e.jsx("div",{className:"chart-panel-body",children:ie()})]})]})]})}export{Ce as default};
