import{a,b as ce,j as e,M as ie,B as de,E as pe,Z as ue,T as F,c as he,f as T,u as me,L as S}from"./index-dxKOQnu-.js";const V="https://data.edmonton.ca/resource/bh8y-pn5j.json",G="https://data.edmonton.ca/resource/6waz-yxqq.json",D=5e4,R={STORM:{color:"#38bdf8",dash:[],weight:2,label:"Storm",style:"Solid"},SANITARY:{color:"#a855f7",dash:[8,4],weight:2,label:"Sanitary",style:"Dashed"},COMBINED:{color:"#f97316",dash:[2,4],weight:2,label:"Combined",style:"Dotted"},"FND DRAIN":{color:"#22d3ee",dash:[],weight:1.2,label:"Fnd Drain",style:"Thin solid"},WATER:{color:"#3b82f6",dash:[],weight:2,label:"Water",style:"Solid"}},P={"110-119":"#e11d48","100-109":"#dc2626","90-99":"#ef4444","80-89":"#7c3aed","70-79":"#c026d3","60-69":"#2563eb","50-59":"#3b82f6","40-49":"#0ea5e9","30-39":"#06b6d4","20-29":"#0891b2","10-19":"#0d9488","0-9":"#10b981",Unknown:"#6b7280"},H=["110-119","100-109","90-99","80-89","70-79","60-69","50-59","40-49","30-39","20-29","10-19","0-9","Unknown"],q=new Date().getFullYear();function L(n){if(!n||n<=0)return"Unknown";const o=q-n;if(o<0)return"Unknown";if(o>=120)return"110-119";const l=Math.floor(o/10)*10;return`${l}-${l+9}`}function Y(n,o){const l=o?.properties?.type,c=o?.properties?.year_const,r=c?parseInt(c,10):null;if(n==="type"){const p=R[l];return{color:p?.color??"#888",weight:p?.weight??2,opacity:.85,dashArray:p?.dash?.length?p.dash.join(" "):void 0}}return{color:P[L(r)]??"#888",weight:2,opacity:.85}}function ge(){const n=T();return a.useEffect(()=>{setTimeout(()=>n.invalidateSize(),100)},[n]),null}function fe({pipes:n,viewMode:o,visibleTypes:l}){const c=T(),r=a.useRef(null),p=a.useRef(null),u=a.useRef(null),h=a.useRef(o);h.current=o;const y=a.useMemo(()=>{const i=[];for(const m of n)l[m.type]&&i.push({type:"Feature",geometry:m.geometry,properties:{type:m.type,year_const:m.year_const}});return{type:"FeatureCollection",features:i}},[n,l]);return a.useEffect(()=>{if(r.current&&(c.removeLayer(r.current),r.current=null),y.features.length===0)return;p.current||(p.current=S.canvas({padding:.5})),u.current||(u.current=S.popup({className:"hydrogrid-popup",maxWidth:280}));const i=u.current,m={style:w=>Y(h.current,w),renderer:p.current,onEachFeature:(w,E)=>{E.on("click",$=>{const x=w.properties??{},_=x.year_const||"Unknown",A=x.year_const?q-parseInt(x.year_const,10):"?";i.setLatLng($.latlng).setContent(`<div style="font-family:monospace;font-size:12px;max-width:240px">
                <div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:3px">${x.type??"Pipe"}</div>
                <table style="border-collapse:collapse">
                  <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Year</td><td>${_}</td></tr>
                  <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Age</td><td>${A} yrs</td></tr>
                </table>
              </div>`).openOn(c)})}},b=S.geoJSON(y,m);return b.addTo(c),r.current=b,()=>{r.current&&(c.removeLayer(r.current),r.current=null)}},[y,c]),a.useEffect(()=>{r.current?.setStyle(i=>Y(o,i))},[o]),null}function ye({manholes:n,viewMode:o,visible:l}){const c=T(),r=a.useRef(null),p=a.useRef(null),u=a.useRef(null);return a.useEffect(()=>{if(r.current&&(c.removeLayer(r.current),r.current=null),!l||n.length===0)return;p.current||(p.current=S.canvas({padding:.5})),u.current||(u.current=S.popup({className:"hydrogrid-popup",maxWidth:240}));const h=u.current,y=S.layerGroup();for(const i of n){const m=parseFloat(i.latitude),b=parseFloat(i.longitude);if(isNaN(m)||isNaN(b))continue;const w=i.year_const?parseInt(i.year_const,10):null,E=L(w),$=o==="type"?"#94a3b8":P[E]??"#94a3b8",x=S.circleMarker([m,b],{radius:3,color:"#e2e8f0",weight:.5,fillColor:$,fillOpacity:.8,renderer:p.current});x.on("click",_=>{h.setLatLng(_.latlng).setContent(`<div style="font-family:monospace;font-size:12px;max-width:200px">
              <div style="font-weight:700;margin-bottom:4px">Manhole — ${i.type}</div>
              <div>Year: ${i.year_const||"Unknown"}</div>
              ${i.road_name?`<div>Road: ${i.road_name}</div>`:""}
            </div>`).openOn(c)}),y.addLayer(x)}return y.addTo(c),r.current=y,()=>{r.current&&(c.removeLayer(r.current),r.current=null)}},[n,o,l,c]),null}function xe({onViewport:n}){const o=me({moveend:()=>n(o.getBounds(),o.getZoom()),zoomend:()=>n(o.getBounds(),o.getZoom())});return a.useEffect(()=>{n(o.getBounds(),o.getZoom())},[o,n]),null}async function be(n,o){const l=[];let c=0;for(;;){if(o.aborted)return l;const r=`${V}?$select=type,year_const,geometry_line&$limit=${D}&$offset=${c}&$order=:id`,u=await(await fetch(r,{signal:o})).json();for(const h of u)h.geometry_line?.coordinates?.[0]?.[0]&&l.push({type:h.type,year_const:h.year_const,geometry:h.geometry_line});if(n(l.length),u.length<D)break;c+=D}return l}function je(){const[n,o]=a.useState("age"),[l,c]=a.useState(ce),[r,p]=a.useState([]),[u,h]=a.useState([]),[y,i]=a.useState(!0),[m,b]=a.useState([]),[w,E]=a.useState(0),[$,x]=a.useState(!1),[_,A]=a.useState(12),[J,I]=a.useState([]),[K,B]=a.useState(!1),[M,Q]=a.useState(()=>{const t={};for(const s of Object.keys(R))t[s]=!0;return t.MANHOLE=!0,t}),z=a.useRef(null),U=a.useRef(void 0);a.useEffect(()=>{let t=!1;return(async()=>{i(!0);try{const[s,g]=await Promise.all([fetch(`${V}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`),fetch(`${G}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`)]);if(t)return;p(await s.json()),h(await g.json())}catch{}t||i(!1)})(),()=>{t=!0}},[]),a.useEffect(()=>{const t=new AbortController;return be(s=>E(s),t.signal).then(s=>{t.signal.aborted||(b(s),x(!0))}).catch(()=>{}),()=>t.abort()},[]);const X=a.useCallback((t,s)=>{clearTimeout(U.current),U.current=setTimeout(()=>{const g=Math.round(s);if(A(g),g<13){I([]);return}z.current?.abort();const N=new AbortController;z.current=N;const d=t.getSouthWest(),f=t.getNorthEast(),v=`latitude > ${d.lat} AND latitude < ${f.lat} AND longitude > ${d.lng} AND longitude < ${f.lng}`,le=g>=15?1e4:4e3;B(!0),fetch(`${G}?$where=${encodeURIComponent(v)}&$select=type,year_const,latitude,longitude,road_name&$limit=${le}`,{signal:N.signal}).then(O=>O.json()).then(O=>{N.signal.aborted||I(O)}).catch(()=>{}).finally(()=>{N.signal.aborted||B(!1)})},250)},[]),{ageData:k,typeData:C,totalPipes:ee,totalManholes:te}=a.useMemo(()=>{const t={};for(const d of H)t[d]={pipes:0,manholes:0};const s={};for(const d of Object.keys(R))s[d]={pipes:0,manholes:0};let g=0,N=0;for(const d of r){const f=parseInt(d.cnt,10)||0,v=L(parseInt(d.year_const,10)||0);t[v]&&(t[v].pipes+=f),s[d.type]&&(s[d.type].pipes+=f),g+=f}for(const d of u){const f=parseInt(d.cnt,10)||0,v=L(parseInt(d.year_const,10)||0);t[v]&&(t[v].manholes+=f),s[d.type]&&(s[d.type].manholes+=f),N+=f}return{ageData:t,typeData:s,totalPipes:g,totalManholes:N}},[r,u]),j=de[l],se=a.useMemo(()=>Math.max(1,...Object.values(n==="age"?k:C).map(s=>s.pipes)),[n,k,C]),Z=t=>Q(s=>({...s,[t]:!s[t]})),ne=n==="age"?H:Object.keys(R),ae=n==="age"?k:C,oe=n==="age"?P:Object.fromEntries(Object.entries(R).map(([t,s])=>[t,s.color])),re=M.MANHOLE&&_>=13,W=$?K?"Loading manholes...":null:`Loading pipes... ${w.toLocaleString()}`;return e.jsxs("div",{className:"dw-view",children:[e.jsxs("aside",{className:"dw-sidebar",children:[e.jsxs("div",{className:"dw-sidebar-header",children:[e.jsx("h2",{children:"Edmonton Drainage & Regional Water"}),y?e.jsx("p",{className:"dw-subtitle",children:"Loading statistics..."}):e.jsxs("p",{className:"dw-subtitle",children:["Total: ",e.jsx("strong",{children:ee.toLocaleString()})," pipe segments •"," ",e.jsx("strong",{children:te.toLocaleString()})," manholes"]})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"View By"}),e.jsxs("div",{className:"dw-toggle-row",children:[e.jsx("button",{className:`dw-toggle-btn ${n==="age"?"active":""}`,onClick:()=>o("age"),children:"Age"}),e.jsx("button",{className:`dw-toggle-btn ${n==="type"?"active":""}`,onClick:()=>o("type"),children:"Type"})]})]}),e.jsxs("div",{className:"dw-section dw-chart-section",children:[e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:n==="age"?"Age (years)":"Type"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),e.jsx("div",{className:"dw-bar-list",children:ne.map(t=>{const s=ae[t]??{pipes:0,manholes:0},g=s.pipes/se*100;return e.jsxs("div",{className:"dw-bar-row",children:[e.jsx("span",{className:"dw-bar-label",children:t}),e.jsx("div",{className:"dw-bar-track",children:e.jsx("div",{className:"dw-bar-fill",style:{width:`${Math.max(g,.5)}%`,backgroundColor:oe[t]??"#888"}})}),e.jsx("span",{className:"dw-bar-value",children:s.pipes.toLocaleString()}),e.jsx("span",{className:"dw-bar-value",children:s.manholes.toLocaleString()})]},t)})})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"Legend & Visibility"}),e.jsxs("div",{className:"dw-legend",children:[Object.entries(R).map(([t,s])=>e.jsxs("button",{className:`dw-legend-item ${M[t]?"active":""}`,onClick:()=>Z(t),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("line",{x1:"0",y1:"5",x2:"32",y2:"5",stroke:s.color,strokeWidth:s.weight,strokeDasharray:s.dash.length?s.dash.join(" "):void 0})}),e.jsxs("span",{className:"dw-legend-label",children:[s.label," — ",s.style]})]},t)),e.jsxs("button",{className:`dw-legend-item ${M.MANHOLE?"active":""}`,onClick:()=>Z("MANHOLE"),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("circle",{cx:"16",cy:"5",r:"4",fill:"#94a3b8",stroke:"#e2e8f0",strokeWidth:"1"})}),e.jsx("span",{className:"dw-legend-label",children:"Manhole"})]})]}),e.jsx("p",{className:"dw-note",children:"Manholes appear at zoom 13+. Click legend to toggle layers."})]}),e.jsx("div",{className:"dw-section dw-footer",children:e.jsxs("p",{children:["Data:"," ",e.jsx("a",{href:"https://data.edmonton.ca",target:"_blank",rel:"noopener noreferrer",children:"Edmonton Open Data"})," / ",e.jsx("a",{href:"https://www.epcor.com",target:"_blank",rel:"noopener noreferrer",children:"EPCOR"})]})})]}),e.jsxs("div",{className:`dw-map-outer ${j.isDark?"theme-dark":"theme-light"}`,children:[W&&e.jsx("div",{className:"dw-map-loading",children:W}),e.jsxs(ie,{center:pe,zoom:12,className:"map-container",zoomControl:!1,preferCanvas:!0,children:[e.jsx(ue,{position:"bottomright"}),e.jsx(ge,{}),e.jsx(xe,{onViewport:X}),e.jsx(F,{attribution:j.attr,url:j.url,..."maxZoom"in j?{maxZoom:j.maxZoom}:{}},l),"labelsUrl"in j&&e.jsx(F,{url:j.labelsUrl,zIndex:650},l+"-labels"),$&&e.jsx(fe,{pipes:m,viewMode:n,visibleTypes:M}),e.jsx(ye,{manholes:J,viewMode:n,visible:re})]}),e.jsx(he,{active:l,onChange:c})]})]})}export{je as default};
