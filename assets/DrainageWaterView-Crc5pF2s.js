import{a as r,b as se,j as e,M as ae,B as ne,E as oe,Z as re,T as k,G as le,C as ie,P as ce,c as de,f as pe,u as he}from"./index-DYznh_Ko.js";const D="https://data.edmonton.ca/resource/bh8y-pn5j.json",A="https://data.edmonton.ca/resource/6waz-yxqq.json",u={STORM:{color:"#38bdf8",dash:[],weight:2,label:"Storm",style:"Solid"},SANITARY:{color:"#a855f7",dash:[8,4],weight:2,label:"Sanitary",style:"Dashed"},COMBINED:{color:"#f97316",dash:[2,4],weight:2,label:"Combined",style:"Dotted"},"FND DRAIN":{color:"#22d3ee",dash:[],weight:1.2,label:"Fnd Drain",style:"Thin solid"},WATER:{color:"#3b82f6",dash:[],weight:2,label:"Water",style:"Solid"}},f={"110-119":"#e11d48","100-109":"#dc2626","90-99":"#ef4444","80-89":"#7c3aed","70-79":"#c026d3","60-69":"#2563eb","50-59":"#3b82f6","40-49":"#0ea5e9","30-39":"#06b6d4","20-29":"#0891b2","10-19":"#0d9488","0-9":"#10b981",Unknown:"#6b7280"},O=["110-119","100-109","90-99","80-89","70-79","60-69","50-59","40-49","30-39","20-29","10-19","0-9","Unknown"],C=new Date().getFullYear();function x(a){if(!a||a<=0)return"Unknown";const i=C-a;if(i<0)return"Unknown";if(i>=120)return"110-119";const d=Math.floor(i/10)*10;return`${d}-${d+9}`}function me(){const a=pe();return r.useEffect(()=>{setTimeout(()=>a.invalidateSize(),100)},[a]),null}function ge({onMove:a}){const i=he({moveend:()=>a(i.getBounds(),i.getZoom()),zoomend:()=>a(i.getBounds(),i.getZoom())});return r.useEffect(()=>{a(i.getBounds(),i.getZoom())},[i,a]),null}function xe(){const[a,i]=r.useState("age"),[d,P]=r.useState(se),[j,T]=r.useState([]),[N,L]=r.useState([]),[I,v]=r.useState(!0),[_,B]=r.useState([]),[U,W]=r.useState([]),[F,$]=r.useState(!1),[g,G]=r.useState(()=>{const t={};for(const s of Object.keys(u))t[s]=!0;return t.MANHOLE=!0,t}),Z=r.useRef(null),z=r.useRef(12),M=r.useRef(void 0);r.useEffect(()=>{let t=!1;async function s(){v(!0);try{const[n,c]=await Promise.all([fetch(`${D}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`),fetch(`${A}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`)]);if(t)return;const o=await n.json(),l=await c.json();t||(T(o),L(l))}catch{}t||v(!1)}return s(),()=>{t=!0}},[]);const S=r.useCallback(async(t,s)=>{const n=t.getSouthWest(),c=t.getNorthEast(),o=`latitude > ${n.lat} AND latitude < ${c.lat} AND longitude > ${n.lng} AND longitude < ${c.lng}`,l=s>=14?1e4:s>=12?6e3:3e3,h=s>=15?5e3:s>=13?2e3:500;$(!0);try{const[m,R]=await Promise.all([fetch(`${D}?$where=${encodeURIComponent(o)}&$select=type,year_const,geometry_line,road_name,neighbourhood_name&$limit=${l}`),s>=13?fetch(`${A}?$where=${encodeURIComponent(o)}&$select=type,year_const,latitude,longitude,road_name&$limit=${h}`):Promise.resolve(null)]),ee=await m.json(),te=R?await R.json():[];B(ee),W(te)}catch{}$(!1)},[]),H=r.useCallback((t,s)=>{Z.current=t,z.current=s,clearTimeout(M.current),M.current=setTimeout(()=>S(t,s),500)},[S]),{ageData:y,typeData:b,totalPipes:Y,totalManholes:V}=r.useMemo(()=>{const t={};for(const o of O)t[o]={pipes:0,manholes:0};const s={};for(const o of Object.keys(u))s[o]={pipes:0,manholes:0};let n=0,c=0;for(const o of j){const l=parseInt(o.cnt,10)||0,h=parseInt(o.year_const,10)||0,m=x(h);t[m]&&(t[m].pipes+=l),s[o.type]&&(s[o.type].pipes+=l),n+=l}for(const o of N){const l=parseInt(o.cnt,10)||0,h=parseInt(o.year_const,10)||0,m=x(h);t[m]&&(t[m].manholes+=l),s[o.type]&&(s[o.type].manholes+=l),c+=l}return{ageData:t,typeData:s,totalPipes:n,totalManholes:c}},[j,N]),w=r.useMemo(()=>{const t=[];for(const s of _)s.geometry_line&&g[s.type]&&t.push({type:"Feature",geometry:s.geometry_line,properties:{type:s.type,year_const:s.year_const,road_name:s.road_name,neighbourhood_name:s.neighbourhood_name}});return{type:"FeatureCollection",features:t}},[_,g]),J=r.useCallback(t=>{const s=t?.properties?.type,n=t?.properties?.year_const,c=n?parseInt(n,10):null;if(a==="type"){const l=u[s];return{color:l?.color??"#888",weight:l?.weight??2,opacity:.85,dashArray:l?.dash?.length?l.dash.join(" "):void 0}}const o=x(c);return{color:f[o]??"#888",weight:2,opacity:.85}},[a]),p=ne[d],q=r.useMemo(()=>Math.max(1,...Object.values(a==="age"?y:b).map(s=>s.pipes)),[a,y,b]),E=t=>G(s=>({...s,[t]:!s[t]})),K=a==="age"?O:Object.keys(u),Q=a==="age"?y:b,X=a==="age"?f:Object.fromEntries(Object.entries(u).map(([t,s])=>[t,s.color]));return e.jsxs("div",{className:"dw-view",children:[e.jsxs("aside",{className:"dw-sidebar",children:[e.jsxs("div",{className:"dw-sidebar-header",children:[e.jsx("h2",{children:"Edmonton Drainage & Regional Water"}),I?e.jsx("p",{className:"dw-subtitle",children:"Loading statistics..."}):e.jsxs("p",{className:"dw-subtitle",children:["Total: ",e.jsx("strong",{children:Y.toLocaleString()})," pipe segments •"," ",e.jsx("strong",{children:V.toLocaleString()})," manholes"]})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"View By"}),e.jsxs("div",{className:"dw-toggle-row",children:[e.jsx("button",{className:`dw-toggle-btn ${a==="age"?"active":""}`,onClick:()=>i("age"),children:"Age"}),e.jsx("button",{className:`dw-toggle-btn ${a==="type"?"active":""}`,onClick:()=>i("type"),children:"Type"})]})]}),e.jsxs("div",{className:"dw-section dw-chart-section",children:[a==="age"&&e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:"Age (years)"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),a==="type"&&e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:"Type"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),e.jsx("div",{className:"dw-bar-list",children:K.map(t=>{const s=Q[t]??{pipes:0,manholes:0},n=s.pipes/q*100;return e.jsxs("div",{className:"dw-bar-row",children:[e.jsx("span",{className:"dw-bar-label",children:t}),e.jsx("div",{className:"dw-bar-track",children:e.jsx("div",{className:"dw-bar-fill",style:{width:`${Math.max(n,.5)}%`,backgroundColor:X[t]??"#888"}})}),e.jsx("span",{className:"dw-bar-value",children:s.pipes.toLocaleString()}),e.jsx("span",{className:"dw-bar-value",children:s.manholes.toLocaleString()})]},t)})})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"Legend & Visibility"}),e.jsxs("div",{className:"dw-legend",children:[Object.entries(u).map(([t,s])=>e.jsxs("button",{className:`dw-legend-item ${g[t]?"active":""}`,onClick:()=>E(t),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("line",{x1:"0",y1:"5",x2:"32",y2:"5",stroke:s.color,strokeWidth:s.weight,strokeDasharray:s.dash.length?s.dash.join(" "):void 0})}),e.jsxs("span",{className:"dw-legend-label",children:[s.label," — ",s.style]})]},t)),e.jsxs("button",{className:`dw-legend-item ${g.MANHOLE?"active":""}`,onClick:()=>E("MANHOLE"),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("circle",{cx:"16",cy:"5",r:"4",fill:"#94a3b8",stroke:"#e2e8f0",strokeWidth:"1"})}),e.jsx("span",{className:"dw-legend-label",children:"Manhole"})]})]}),e.jsx("p",{className:"dw-note",children:"Manholes appear at zoom 13+. Click items to toggle."})]}),e.jsx("div",{className:"dw-section dw-footer",children:e.jsxs("p",{children:["Data:"," ",e.jsx("a",{href:"https://data.edmonton.ca",target:"_blank",rel:"noopener noreferrer",children:"Edmonton Open Data"})," / ",e.jsx("a",{href:"https://www.epcor.com",target:"_blank",rel:"noopener noreferrer",children:"EPCOR"})]})})]}),e.jsxs("div",{className:`dw-map-outer ${p.isDark?"theme-dark":"theme-light"}`,children:[F&&e.jsx("div",{className:"dw-map-loading",children:"Loading pipes..."}),e.jsxs(ae,{center:oe,zoom:12,className:"map-container",zoomControl:!1,children:[e.jsx(re,{position:"bottomright"}),e.jsx(me,{}),e.jsx(ge,{onMove:H}),e.jsx(k,{attribution:p.attr,url:p.url,..."maxZoom"in p?{maxZoom:p.maxZoom}:{}},d),"labelsUrl"in p&&e.jsx(k,{url:p.labelsUrl,zIndex:650},d+"-labels"),w.features.length>0&&e.jsx(le,{data:w,style:J,onEachFeature:(t,s)=>{const n=t.properties??{},c=n.year_const||"Unknown",o=n.year_const?C-parseInt(n.year_const,10):"?";s.bindPopup(`<div style="font-family:monospace;font-size:12px;max-width:240px">
                    <div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:3px">${n.type??"Pipe"}</div>
                    <table style="border-collapse:collapse">
                      <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Year</td><td>${c}</td></tr>
                      <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Age</td><td>${o} yrs</td></tr>
                      ${n.road_name?`<tr><td style="padding:1px 8px 1px 0;opacity:0.6">Road</td><td>${n.road_name}</td></tr>`:""}
                      ${n.neighbourhood_name?`<tr><td style="padding:1px 8px 1px 0;opacity:0.6">Area</td><td>${n.neighbourhood_name}</td></tr>`:""}
                    </table>
                  </div>`,{className:"hydrogrid-popup",maxWidth:280})}},`pipes-${w.features.length}-${a}-${JSON.stringify(g)}`),g.MANHOLE&&U.map((t,s)=>{const n=parseFloat(t.latitude),c=parseFloat(t.longitude);if(isNaN(n)||isNaN(c))return null;const o=t.year_const?parseInt(t.year_const,10):null,l=x(o),h=a==="type"?"#94a3b8":f[l]??"#94a3b8";return e.jsx(ie,{center:[n,c],radius:3,pathOptions:{color:"#e2e8f0",weight:.5,fillColor:h,fillOpacity:.8},children:e.jsx(ce,{className:"hydrogrid-popup",maxWidth:240,children:e.jsxs("div",{style:{fontFamily:"monospace",fontSize:12,maxWidth:200},children:[e.jsxs("div",{style:{fontWeight:700,marginBottom:4},children:["Manhole — ",t.type]}),e.jsxs("div",{children:["Year: ",t.year_const||"Unknown"]}),t.road_name&&e.jsxs("div",{children:["Road: ",t.road_name]})]})})},`mh-${s}`)})]}),e.jsx(de,{active:d,onChange:P})]})]})}export{xe as default};
