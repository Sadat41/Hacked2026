import{a,b as de,j as e,M as pe,B as ue,E as he,Z as me,T as G,c as fe,f as Z,u as q,L as S}from"./index-CMn6XrNp.js";const J="https://data.edmonton.ca/resource/bh8y-pn5j.json",H="https://data.edmonton.ca/resource/6waz-yxqq.json",I=5e4,M={STORM:{color:"#38bdf8",dash:[],weight:2,label:"Storm",style:"Solid"},SANITARY:{color:"#a855f7",dash:[8,4],weight:2,label:"Sanitary",style:"Dashed"},COMBINED:{color:"#f97316",dash:[2,4],weight:2,label:"Combined",style:"Dotted"},"FND DRAIN":{color:"#22d3ee",dash:[],weight:1.2,label:"Fnd Drain",style:"Thin solid"},WATER:{color:"#3b82f6",dash:[],weight:2,label:"Water",style:"Solid"}},z={"110-119":"#e11d48","100-109":"#dc2626","90-99":"#ef4444","80-89":"#7c3aed","70-79":"#c026d3","60-69":"#2563eb","50-59":"#3b82f6","40-49":"#0ea5e9","30-39":"#06b6d4","20-29":"#0891b2","10-19":"#0d9488","0-9":"#10b981",Unknown:"#6b7280"},Y=["110-119","100-109","90-99","80-89","70-79","60-69","50-59","40-49","30-39","20-29","10-19","0-9","Unknown"],K=new Date().getFullYear();function A(n){if(!n||n<=0)return"Unknown";const o=K-n;if(o<0)return"Unknown";if(o>=120)return"110-119";const r=Math.floor(o/10)*10;return`${r}-${r+9}`}function V(n,o){const r=o?.properties?.type,l=o?.properties?.year_const,c=l?parseInt(l,10):null;if(n==="type"){const p=M[r];return{color:p?.color??"#888",weight:p?.weight??2,opacity:.85,dashArray:p?.dash?.length?p.dash.join(" "):void 0}}return{color:z[A(c)]??"#888",weight:2,opacity:.85}}function ge(){const n=Z();return a.useEffect(()=>{setTimeout(()=>n.invalidateSize(),100)},[n]),null}function ye({pipes:n,viewMode:o,visibleTypes:r}){const l=Z(),c=a.useRef(null),p=a.useRef(null),h=a.useRef(null),u=a.useRef(o);u.current=o;const x=a.useMemo(()=>{const m=[];for(const i of n)r[i.type]&&m.push({type:"Feature",geometry:i.geometry,properties:{type:i.type,year_const:i.year_const}});return{type:"FeatureCollection",features:m}},[n,r]);return a.useEffect(()=>{if(c.current&&(l.removeLayer(c.current),c.current=null),x.features.length===0)return;p.current||(p.current=S.canvas({padding:.5})),h.current||(h.current=S.popup({className:"hydrogrid-popup",maxWidth:280}));const m=h.current,i={style:y=>V(u.current,y),renderer:p.current,onEachFeature:(y,R)=>{R.on("click",$=>{const b=y.properties??{},E=b.year_const||"Unknown",_=b.year_const?K-parseInt(b.year_const,10):"?";m.setLatLng($.latlng).setContent(`<div style="font-family:monospace;font-size:12px;max-width:240px">
                <div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:3px">${b.type??"Pipe"}</div>
                <table style="border-collapse:collapse">
                  <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Year</td><td>${E}</td></tr>
                  <tr><td style="padding:1px 8px 1px 0;opacity:0.6">Age</td><td>${_} yrs</td></tr>
                </table>
              </div>`).openOn(l)})}},w=S.geoJSON(x,i);return w.addTo(l),c.current=w,()=>{c.current&&(l.removeLayer(c.current),c.current=null)}},[x,l]),a.useEffect(()=>{c.current?.setStyle(m=>V(o,m))},[o]),null}const B=13;function be({manholes:n,viewMode:o,visible:r}){const l=Z(),c=a.useRef(null),p=a.useRef(null),h=a.useRef(null),u=a.useCallback(()=>{c.current&&(l.removeLayer(c.current),c.current=null)},[l]);return q({zoomend:()=>{l.getZoom()<B&&u()}}),a.useEffect(()=>{if(u(),!r||n.length===0)return;p.current||(p.current=S.canvas({padding:.5})),h.current||(h.current=S.popup({className:"hydrogrid-popup",maxWidth:240}));const x=h.current,m=S.layerGroup();for(const i of n){const w=parseFloat(i.latitude),y=parseFloat(i.longitude);if(isNaN(w)||isNaN(y))continue;const R=i.year_const?parseInt(i.year_const,10):null,$=A(R),b=o==="type"?"#94a3b8":z[$]??"#94a3b8",E=S.circleMarker([w,y],{radius:3,color:"#e2e8f0",weight:.5,fillColor:b,fillOpacity:.8,renderer:p.current});E.on("click",_=>{x.setLatLng(_.latlng).setContent(`<div style="font-family:monospace;font-size:12px;max-width:200px">
              <div style="font-weight:700;margin-bottom:4px">Manhole — ${i.type}</div>
              <div>Year: ${i.year_const||"Unknown"}</div>
              ${i.road_name?`<div>Road: ${i.road_name}</div>`:""}
            </div>`).openOn(l)}),m.addLayer(E)}return m.addTo(l),c.current=m,()=>u()},[n,o,r,l,u]),null}function xe({onViewport:n}){const o=q({moveend:()=>n(o.getBounds(),o.getZoom()),zoomend:()=>n(o.getBounds(),o.getZoom())});return a.useEffect(()=>{n(o.getBounds(),o.getZoom())},[o,n]),null}async function we(n,o){const r=[];let l=0;for(;;){if(o.aborted)return r;const c=`${J}?$select=type,year_const,geometry_line&$limit=${I}&$offset=${l}&$order=:id`,h=await(await fetch(c,{signal:o})).json();for(const u of h)u.geometry_line?.coordinates?.[0]?.[0]&&r.push({type:u.type,year_const:u.year_const,geometry:u.geometry_line});if(n(r.length),h.length<I)break;l+=I}return r}function Ne(){const[n,o]=a.useState("age"),[r,l]=a.useState(de),[c,p]=a.useState([]),[h,u]=a.useState([]),[x,m]=a.useState(!0),[i,w]=a.useState([]),[y,R]=a.useState(0),[$,b]=a.useState(!1),[E,_]=a.useState(12),[Q,U]=a.useState([]),[X,k]=a.useState(!1),[L,ee]=a.useState(()=>{const t={};for(const s of Object.keys(M))t[s]=!0;return t.MANHOLE=!0,t}),O=a.useRef(null),C=a.useRef(void 0);a.useEffect(()=>{let t=!1;return(async()=>{m(!0);try{const[s,f]=await Promise.all([fetch(`${J}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`),fetch(`${H}?$select=type,year_const,count(*) as cnt&$group=type,year_const&$limit=50000`)]);if(t)return;p(await s.json()),u(await f.json())}catch{}t||m(!1)})(),()=>{t=!0}},[]),a.useEffect(()=>{const t=new AbortController;return we(s=>R(s),t.signal).then(s=>{t.signal.aborted||(w(s),b(!0))}).catch(()=>{}),()=>t.abort()},[]);const te=a.useCallback((t,s)=>{const f=Math.floor(s);if(_(f),f<B){clearTimeout(C.current),O.current?.abort(),U([]),k(!1);return}clearTimeout(C.current),C.current=setTimeout(()=>{O.current?.abort();const N=new AbortController;O.current=N;const d=t.getSouthWest(),g=t.getNorthEast(),v=`latitude > ${d.lat} AND latitude < ${g.lat} AND longitude > ${d.lng} AND longitude < ${g.lng}`,ie=f>=15?1e4:4e3;k(!0),fetch(`${H}?$where=${encodeURIComponent(v)}&$select=type,year_const,latitude,longitude,road_name&$limit=${ie}`,{signal:N.signal}).then(P=>P.json()).then(P=>{N.signal.aborted||U(P)}).catch(()=>{}).finally(()=>{N.signal.aborted||k(!1)})},250)},[]),{ageData:T,typeData:D,totalPipes:se,totalManholes:ne}=a.useMemo(()=>{const t={};for(const d of Y)t[d]={pipes:0,manholes:0};const s={};for(const d of Object.keys(M))s[d]={pipes:0,manholes:0};let f=0,N=0;for(const d of c){const g=parseInt(d.cnt,10)||0,v=A(parseInt(d.year_const,10)||0);t[v]&&(t[v].pipes+=g),s[d.type]&&(s[d.type].pipes+=g),f+=g}for(const d of h){const g=parseInt(d.cnt,10)||0,v=A(parseInt(d.year_const,10)||0);t[v]&&(t[v].manholes+=g),s[d.type]&&(s[d.type].manholes+=g),N+=g}return{ageData:t,typeData:s,totalPipes:f,totalManholes:N}},[c,h]),j=ue[r],ae=a.useMemo(()=>Math.max(1,...Object.values(n==="age"?T:D).map(s=>s.pipes)),[n,T,D]),W=t=>ee(s=>({...s,[t]:!s[t]})),oe=n==="age"?Y:Object.keys(M),re=n==="age"?T:D,le=n==="age"?z:Object.fromEntries(Object.entries(M).map(([t,s])=>[t,s.color])),ce=L.MANHOLE&&E>=B,F=$?X?"Loading manholes...":null:`Loading pipes... ${y.toLocaleString()}`;return e.jsxs("div",{className:"dw-view",children:[e.jsxs("aside",{className:"dw-sidebar",children:[e.jsxs("div",{className:"dw-sidebar-header",children:[e.jsx("h2",{children:"Edmonton Drainage & Regional Water"}),x?e.jsx("p",{className:"dw-subtitle",children:"Loading statistics..."}):e.jsxs("p",{className:"dw-subtitle",children:["Total: ",e.jsx("strong",{children:se.toLocaleString()})," pipe segments •"," ",e.jsx("strong",{children:ne.toLocaleString()})," manholes"]})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"View By"}),e.jsxs("div",{className:"dw-toggle-row",children:[e.jsx("button",{className:`dw-toggle-btn ${n==="age"?"active":""}`,onClick:()=>o("age"),children:"Age"}),e.jsx("button",{className:`dw-toggle-btn ${n==="type"?"active":""}`,onClick:()=>o("type"),children:"Type"})]})]}),e.jsxs("div",{className:"dw-section dw-chart-section",children:[e.jsxs("div",{className:"dw-chart-header-labels",children:[e.jsx("span",{className:"dw-chart-axis-label",children:n==="age"?"Age (years)":"Type"}),e.jsxs("span",{className:"dw-chart-axis-right",children:[e.jsx("span",{children:"Pipes"}),e.jsx("span",{children:"Manholes"})]})]}),e.jsx("div",{className:"dw-bar-list",children:oe.map(t=>{const s=re[t]??{pipes:0,manholes:0},f=s.pipes/ae*100;return e.jsxs("div",{className:"dw-bar-row",children:[e.jsx("span",{className:"dw-bar-label",children:t}),e.jsx("div",{className:"dw-bar-track",children:e.jsx("div",{className:"dw-bar-fill",style:{width:`${Math.max(f,.5)}%`,backgroundColor:le[t]??"#888"}})}),e.jsx("span",{className:"dw-bar-value",children:s.pipes.toLocaleString()}),e.jsx("span",{className:"dw-bar-value",children:s.manholes.toLocaleString()})]},t)})})]}),e.jsxs("div",{className:"dw-section",children:[e.jsx("label",{className:"dw-label",children:"Legend & Visibility"}),e.jsxs("div",{className:"dw-legend",children:[Object.entries(M).map(([t,s])=>e.jsxs("button",{className:`dw-legend-item ${L[t]?"active":""}`,onClick:()=>W(t),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("line",{x1:"0",y1:"5",x2:"32",y2:"5",stroke:s.color,strokeWidth:s.weight,strokeDasharray:s.dash.length?s.dash.join(" "):void 0})}),e.jsxs("span",{className:"dw-legend-label",children:[s.label," — ",s.style]})]},t)),e.jsxs("button",{className:`dw-legend-item ${L.MANHOLE?"active":""}`,onClick:()=>W("MANHOLE"),children:[e.jsx("svg",{width:"32",height:"10",viewBox:"0 0 32 10",children:e.jsx("circle",{cx:"16",cy:"5",r:"4",fill:"#94a3b8",stroke:"#e2e8f0",strokeWidth:"1"})}),e.jsx("span",{className:"dw-legend-label",children:"Manhole"})]})]}),e.jsx("p",{className:"dw-note",children:"Manholes appear at zoom 13+. Click legend to toggle layers."})]}),e.jsx("div",{className:"dw-section dw-footer",children:e.jsxs("p",{children:["Data:"," ",e.jsx("a",{href:"https://data.edmonton.ca",target:"_blank",rel:"noopener noreferrer",children:"Edmonton Open Data"})," / ",e.jsx("a",{href:"https://www.epcor.com",target:"_blank",rel:"noopener noreferrer",children:"EPCOR"})]})})]}),e.jsxs("div",{className:`dw-map-outer ${j.isDark?"theme-dark":"theme-light"}`,children:[F&&e.jsx("div",{className:"dw-map-loading",children:F}),e.jsxs(pe,{center:he,zoom:12,className:"map-container",zoomControl:!1,preferCanvas:!0,children:[e.jsx(me,{position:"bottomright"}),e.jsx(ge,{}),e.jsx(xe,{onViewport:te}),e.jsx(G,{attribution:j.attr,url:j.url,..."maxZoom"in j?{maxZoom:j.maxZoom}:{}},r),"labelsUrl"in j&&e.jsx(G,{url:j.labelsUrl,zIndex:650},r+"-labels"),$&&e.jsx(ye,{pipes:i,viewMode:n,visibleTypes:L}),e.jsx(be,{manholes:Q,viewMode:n,visible:ce})]}),e.jsx(fe,{active:r,onChange:l})]})]})}export{Ne as default};
